<!-- admin/products.html -->
<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10kVendor | Products</title>
    <link rel="icon" type="image/x-icon" href="/admin/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF7A2F',
                        dark: '#3A1F0B',
                    }
                }
            }
        }
    </script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        .sidebar-collapsed { width: 80px; }
        .sidebar-collapsed .nav-text { display: none; }
        .sidebar-collapsed .logo-text { display: none; }
        .sidebar-collapsed .nav-item { justify-content: center; }
        .dark .dark\:bg-dark { background-color: #1a120b; }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: .5; }
            50% { opacity: .2; }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark text-dark dark:text-gray-200 transition-colors duration-300">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-lg flex flex-col transition-all duration-300">
            <div class="p-4 flex items-center border-b border-gray-200 dark:border-gray-700">
                <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
                    <i data-feather="zap" class="text-white"></i>
                </div>
                <span class="logo-text ml-3 font-bold text-xl">10kVendor</span>
            </div>
            <div class="flex-1 overflow-y-auto py-4">
                <div class="px-4 mb-6">
                    <div class="relative">
                        <input type="text" placeholder="Search..." class="w-full pl-10 pr-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                        <i data-feather="search" class="absolute left-3 top-2.5 text-gray-500"></i>
                    </div>
                </div>
                <nav>
                    <div class="px-2">
                        <div class="nav-item mb-1">
                            <a href="/admin/index.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-feather="home"></i>
                                <span class="nav-text ml-3">Dashboard</span>
                            </a>
                        </div>
                        <div class="nav-item mb-1">
                            <a href="/admin/visitors.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-feather="users"></i>
                                <span class="nav-text ml-3">Visitors</span>
                            </a>
                        </div>
                        <div class="nav-item mb-1">
                            <a href="/admin/ads-marketing.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-feather="dollar-sign"></i>
                                <span class="nav-text ml-3">Ads & Marketing</span>
                            </a>
                        </div>
                        <div class="nav-item mb-1">
                            <a href="/admin/sales-orders.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-feather="shopping-bag"></i>
                                <span class="nav-text ml-3">Sales & Orders</span>
                            </a>
                        </div>
                        <div class="nav-item mb-1">
                            <a href="/admin/products.html" class="flex items-center px-4 py-3 rounded-lg bg-primary bg-opacity-10 text-primary">
                                <i data-feather="package"></i>
                                <span class="nav-text ml-3">Products</span>
                            </a>
                        </div>
                        <div class="nav-item mb-1">
                            <a href="/admin/shipping.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-feather="truck"></i>
                                <span class="nav-text ml-3">Shipping</span>
                            </a>
                        </div>
                        <div class="nav-item mb-1">
                            <a href="/admin/customers.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-feather="user"></i>
                                <span class="nav-text ml-3">Customers</span>
                            </a>
                        </div>
                        <div class="nav-item mb-1">
                            <a href="/admin/financials.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-feather="bar-chart-2"></i>
                                <span class="nav-text ml-3">Financials</span>
                            </a>
                        </div>
                        <div class="nav-item mb-1">
                            <a href="/admin/security.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-feather="shield"></i>
                                <span class="nav-text ml-3">Security</span>
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
                        <i data-feather="user" class="text-white"></i>
                    </div>
                    <div class="ml-3">
                        <div id="admin-name" class="font-medium">Admin User</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Super Admin</div>
                    </div>
                    <button id="theme-toggle" class="ml-auto p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-feather="moon" class="hidden dark:block"></i>
                        <i data-feather="sun" class="dark:hidden"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <header class="bg-white dark:bg-gray-800 shadow-sm">
                <div class="px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="mr-4 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i data-feather="menu"></i>
                        </button>
                        <h1 class="text-xl font-semibold">Products & Categories</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 relative">
                            <i data-feather="bell"></i>
                            <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                        </button>
                        <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i data-feather="message-square"></i>
                        </button>
                    </div>
                </div>
            </header>

            <main class="p-6">
                <div id="error-message" class="hidden text-red-500 text-sm mb-4 text-center"></div>

                <!-- Category Management -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 mb-6" data-aos="fade-up">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold">Categories</h2>
                        <button onclick="openCategoryModal()" class="px-4 py-2 bg-primary text-white rounded-lg">Add Category</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left border-b border-gray-200 dark:border-gray-700">
                                    <th class="pb-3">Name</th>
                                    <th class="pb-3">Icon</th>
                                    <th class="pb-3">Item Count</th>
                                    <th class="pb-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categories-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Product Management -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6" data-aos="fade-up">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold">Products</h2>
                        <button onclick="openProductModal()" class="px-4 py-2 bg-primary text-white rounded-lg">Add Product</button>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm text-gray-500 dark:text-gray-400">Filter by Category</label>
                        <select id="filter-category" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left border-b border-gray-200 dark:border-gray-700">
                                    <th class="pb-3">Image</th>
                                    <th class="pb-3">Name</th>
                                    <th class="pb-3">Price</th>
                                    <th class="pb-3">Category</th>
                                    <th class="pb-3">Stock</th>
                                    <th class="pb-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div id="table-info" class="text-sm text-gray-500 dark:text-gray-400">Loading...</div>
                        <div class="flex space-x-2" id="pagination"></div>
                    </div>
                </div>

                <!-- Category Modal -->
                <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl w-full max-w-md">
                        <h3 id="category-modal-title" class="font-semibold mb-4">Add Category</h3>
                        <form id="category-form">
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Name</label>
                                <input type="text" id="category-name" name="name" required class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Icon (Feather Icon Name)</label>
                                <input type="text" id="category-icon" name="icon" required class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button type="button" onclick="closeCategoryModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg">Save</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Product Modal -->
                <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl w-full max-w-lg">
                        <h3 id="product-modal-title" class="font-semibold mb-4">Add Product</h3>
                        <form id="product-form" enctype="multipart/form-data">
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Name</label>
                                <input type="text" id="product-name" name="name" required class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Description</label>
                                <textarea id="product-description" name="description" required class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Price</label>
                                <input type="number" id="product-price" name="price" required class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Original Price</label>
                                <input type="number" id="product-originalPrice" name="originalPrice" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Discount (%)</label>
                                <input type="number" id="product-discount" name="discount" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Category</label>
                                <select id="product-category" name="category" required class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Stock</label>
                                <input type="number" id="product-stock" name="stock" required class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Specifications (JSON)</label>
                                <textarea id="product-specifications" name="specifications" placeholder='{"key": "value"}' class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Images (Max 5)</label>
                                <input type="file" id="product-images" name="images" multiple accept="image/*" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 dark:text-gray-400">Product Flags</label>
                                <div class="flex flex-wrap gap-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="product-isFlashDeal" name="isFlashDeal" class="mr-2">
                                        <span>Flash Deal</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="product-isBestSeller" name="isBestSeller" class="mr-2">
                                        <span>Best Seller</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="product-isUnder5k" name="isUnder5k" class="mr-2">
                                        <span>Under ₦5k</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="product-isUnder10k" name="isUnder10k" class="mr-2">
                                        <span>Under ₦10k</span>
                                    </label>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button type="button" onclick="closeProductModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs/lib/anime.iife.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js" onerror="loadLocalAOS()"></script>
   <script>
  const API_BASE_URL = 'http://localhost:5000/api';

  // Fallback for AOS if CDN fails
  function loadLocalAOS() {
    const script = document.createElement('script');
    script.src = '/admin/static/aos.js';
    document.body.appendChild(script);
  }

  // Fallback for Anime.js if CDN fails
  function loadLocalAnime() {
    const script = document.createElement('script');
    script.src = '/admin/static/anime.min.js';
    document.body.appendChild(script);
  }

  // Initialize on DOM content loaded
  document.addEventListener('DOMContentLoaded', async () => {
    if (typeof AOS !== 'undefined') {
      AOS.init();
    } else {
      console.warn('AOS not loaded, animations disabled');
    }
    if (typeof anime === 'undefined') {
      console.warn('Anime.js not loaded, error animations disabled');
      loadLocalAnime();
    }

    const token = await checkAuth();
    if (token) {
      await Promise.all([loadCategories(), loadProducts(), populateCategoryFilter(), populateProductCategoryDropdown()]);
      initWebSocket(token);
    }
    feather.replace();
  });

  // Theme toggle
  const themeToggle = document.getElementById('theme-toggle');
  const html = document.documentElement;
  themeToggle.addEventListener('click', () => {
    html.classList.toggle('dark');
    localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
  });

  // Sidebar toggle
  const sidebarToggle = document.getElementById('sidebar-toggle');
  const sidebar = document.getElementById('sidebar');
  sidebarToggle.addEventListener('click', () => {
    sidebar.classList.toggle('sidebar-collapsed');
  });

  // Error display function
  function showError(message) {
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
    if (typeof anime !== 'undefined') {
      anime({
        targets: '#error-message',
        opacity: [0, 1],
        translateY: [-10, 0],
        duration: 500
      });
    } else {
      console.warn('Anime.js not available, skipping error animation');
    }
  }

  // Authentication check
  async function checkAuth() {
    const token = localStorage.getItem('token');
    if (!token) {
      console.error('No token found in localStorage');
      window.location.href = '/admin/login.html';
      return false;
    }
    try {
      const response = await fetch(`${API_BASE_URL}/users/profile`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Profile fetch failed: ${response.status} ${response.statusText} - ${errorText}`);
        throw new Error(`Profile fetch failed: ${response.status} ${response.statusText}`);
      }
      const data = await response.json();
      if (!data.isAdmin) {
        console.error('User is not an admin:', data);
        localStorage.removeItem('token');
        window.location.href = '/admin/login.html';
        return false;
      }
      document.getElementById('admin-name').textContent = data.name || 'Admin User';
      return token;
    } catch (error) {
      console.error('Auth check error:', error.message);
      showError('Authentication failed. Please log in again.');
      localStorage.removeItem('token');
      window.location.href = '/admin/login.html';
      return false;
    }
  }

  // Initialize WebSocket
  let socket;
  function initWebSocket(token) {
    socket = io('http://localhost:5000');
    socket.on('connect', () => {
      socket.emit('joinAdmin', `Bearer ${token}`);
    });
    socket.on('categoryUpdate', () => {
      loadCategories();
      populateCategoryFilter();
      populateProductCategoryDropdown();
    });
    socket.on('productUpdate', () => {
      loadProducts();
    });
  }

  // Category Management
  async function loadCategories() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE_URL}/categories`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Categories fetch failed: ${response.status} ${response.statusText} - ${errorText}`);
        throw new Error(`Categories fetch failed: ${response.status} ${response.statusText}`);
      }
      const categories = await response.json();
      const tbody = document.getElementById('categories-table');
      tbody.innerHTML = categories.length === 0
        ? '<tr><td colspan="4" class="py-4 text-center">No categories found</td></tr>'
        : categories.map(category => `
          <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
            <td class="py-4">${category.name}</td>
            <td class="py-4"><i data-feather="${category.icon}"></i></td>
            <td class="py-4">${category.itemCount}</td>
            <td class="py-4">
              <button onclick="editCategory('${category._id}', '${category.name}', '${category.icon}')" class="p-1 text-blue-500"><i data-feather="edit"></i></button>
              <button onclick="deleteCategory('${category._id}')" class="p-1 text-red-500"><i data-feather="trash-2"></i></button>
            </td>
          </tr>
        `).join('');
      feather.replace();
    } catch (error) {
      console.error('Error loading categories:', error);
      showError('Failed to load categories. Please try again.');
    }
  }

  function openCategoryModal(id = null, name = '', icon = '') {
    document.getElementById('category-modal-title').textContent = id ? 'Edit Category' : 'Add Category';
    document.getElementById('category-name').value = name;
    document.getElementById('category-icon').value = icon;
    document.getElementById('category-form').dataset.id = id || '';
    document.getElementById('category-modal').classList.remove('hidden');
  }

  function closeCategoryModal() {
    document.getElementById('category-modal').classList.add('hidden');
    document.getElementById('category-form').reset();
    document.getElementById('category-form').dataset.id = '';
  }

  document.getElementById('category-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = e.target.dataset.id;
    const name = document.getElementById('category-name').value;
    const icon = document.getElementById('category-icon').value;
    const token = localStorage.getItem('token');
    try {
      const response = await fetch(`${API_BASE_URL}/categories${id ? `/${id}` : ''}`, {
        method: id ? 'PUT' : 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, icon })
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Category ${id ? 'update' : 'creation'} failed: ${response.status} ${response.statusText} - ${errorText}`);
        throw new Error(`Category ${id ? 'update' : 'creation'} failed: ${response.status} ${response.statusText}`);
      }
      closeCategoryModal();
      await loadCategories();
      await populateCategoryFilter();
      await populateProductCategoryDropdown();
      socket.emit('categoryUpdate');
    } catch (error) {
      console.error('Error saving category:', error);
      showError(`Failed to ${id ? 'update' : 'create'} category. Please try again.`);
    }
  });

  async function deleteCategory(id) {
    if (!confirm('Are you sure you want to delete this category?')) return;
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE_URL}/categories/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Category deletion failed: ${response.status} ${response.statusText} - ${errorText}`);
        throw new Error(`Category deletion failed: ${response.status} ${response.statusText}`);
      }
      await loadCategories();
      await populateCategoryFilter();
      await populateProductCategoryDropdown();
      socket.emit('categoryUpdate');
    } catch (error) {
      console.error('Error deleting category:', error);
      showError('Failed to delete category. Please try again.');
    }
  }

  // Product Management
  async function loadProducts(page = 1, limit = 5) {
    try {
      const token = localStorage.getItem('token');
      const category = document.getElementById('filter-category').value;
      const url = `${API_BASE_URL}/products?page=${page}&limit=${limit}${category ? `&category=${category}` : ''}`;
      console.log(`Fetching products from: ${url}`);
      const response = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Products fetch failed: ${response.status} ${response.statusText} - ${errorText}`);
        throw new Error(`Products fetch failed: ${response.status} ${response.statusText}`);
      }
      const { products, total } = await response.json();
      console.log(`Received ${products.length} products, total: ${total}`);
      const tbody = document.getElementById('products-table');
      tbody.innerHTML = products.length === 0
        ? '<tr><td colspan="6" class="py-4 text-center">No products found</td></tr>'
        : products.map(product => `
          <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
            <td class="py-4">
              <img src="${product.images[0]?.url || 'https://via.placeholder.com/50'}" alt="${product.name}" class="w-12 h-12 object-cover rounded">
            </td>
            <td class="py-4">${product.name}</td>
            <td class="py-4">₦${product.price.toLocaleString()}</td>
            <td class="py-4">${product.category?.name || 'Uncategorized'}</td>
            <td class="py-4">${product.stock}</td>
            <td class="py-4">
              <button onclick='editProduct(${JSON.stringify(product)})' class="p-1 text-blue-500"><i data-feather="edit"></i></button>
              <button onclick="deleteProduct('${product._id}')" class="p-1 text-red-500"><i data-feather="trash-2"></i></button>
            </td>
          </tr>
        `).join('');

      const totalPages = Math.ceil(total / limit);
      document.getElementById('table-info').textContent = `Showing ${products.length} of ${total} products`;
      document.getElementById('pagination').innerHTML = `
        <button class="px-3 py-1 rounded-lg bg-gray-100 dark:bg-gray-700" onclick="loadProducts(${page - 1})" ${page === 1 ? 'disabled' : ''}>
          <i data-feather="chevron-left" class="w-4 h-4"></i>
        </button>
        <button class="px-3 py-1 rounded-lg bg-primary text-white">${page}</button>
        <button class="px-3 py-1 rounded-lg bg-gray-100 dark:bg-gray-700" onclick="loadProducts(${page + 1})" ${page >= totalPages ? 'disabled' : ''}>
          <i data-feather="chevron-right" class="w-4 h-4"></i>
        </button>
      `;
      feather.replace();
    } catch (error) {
      console.error('Error loading products:', error);
      showError('Failed to load products. Please try again.');
    }
  }

  async function populateCategoryFilter() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE_URL}/categories`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Categories fetch failed: ${response.status} ${response.statusText} - ${errorText}`);
        throw new Error(`Categories fetch failed: ${response.status} ${response.statusText}`);
      }
      const categories = await response.json();
      const select = document.getElementById('filter-category');
      select.innerHTML = '<option value="">All Categories</option>' + 
        categories.map(category => `<option value="${category._id}">${category.name}</option>`).join('');
      select.addEventListener('change', () => loadProducts());
    } catch (error) {
      console.error('Error populating category filter:', error);
      showError('Failed to load category filter. Please try again.');
    }
  }

  async function populateProductCategoryDropdown() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE_URL}/categories`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Categories fetch failed: ${response.status} ${response.statusText} - ${errorText}`);
        throw new Error(`Categories fetch failed: ${response.status} ${response.statusText}`);
      }
      const categories = await response.json();
      const select = document.getElementById('product-category');
      select.innerHTML = '<option value="">Select Category</option>' + 
        categories.map(category => `<option value="${category._id}">${category.name}</option>`).join('');
    } catch (error) {
      console.error('Error populating product category dropdown:', error);
      showError('Failed to load categories for product form. Please try again.');
    }
  }

  function openProductModal(product = null) {
    document.getElementById('product-modal-title').textContent = product ? 'Edit Product' : 'Add Product';
    document.getElementById('product-name').value = product?.name || '';
    document.getElementById('product-description').value = product?.description || '';
    document.getElementById('product-price').value = product?.price || '';
    document.getElementById('product-originalPrice').value = product?.originalPrice || '';
    document.getElementById('product-discount').value = product?.discount || '';
    document.getElementById('product-category').value = product?.category?._id || '';
    document.getElementById('product-stock').value = product?.stock || '';
    document.getElementById('product-specifications').value = product?.specifications ? JSON.stringify(product.specifications, null, 2) : '';
    document.getElementById('product-images').value = '';
    document.getElementById('product-isFlashDeal').checked = product?.isFlashDeal || false;
    document.getElementById('product-isBestSeller').checked = product?.isBestSeller || false;
    document.getElementById('product-isUnder5k').checked = product?.isUnder5k || false;
    document.getElementById('product-isUnder10k').checked = product?.isUnder10k || false;
    document.getElementById('product-form').dataset.id = product?._id || '';
    document.getElementById('product-modal').classList.remove('hidden');
    populateProductCategoryDropdown();
  }

  function closeProductModal() {
    document.getElementById('product-modal').classList.add('hidden');
    document.getElementById('product-form').reset();
    document.getElementById('product-form').dataset.id = '';
  }

  document.getElementById('product-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = e.target.dataset.id;
    const formData = new FormData();
    formData.append('name', document.getElementById('product-name').value);
    formData.append('description', document.getElementById('product-description').value);
    formData.append('price', document.getElementById('product-price').value);
    formData.append('originalPrice', document.getElementById('product-originalPrice').value);
    formData.append('discount', document.getElementById('product-discount').value);
    formData.append('category', document.getElementById('product-category').value);
    formData.append('stock', document.getElementById('product-stock').value);
    formData.append('specifications', document.getElementById('product-specifications').value);
    formData.append('isFlashDeal', document.getElementById('product-isFlashDeal').checked);
    formData.append('isBestSeller', document.getElementById('product-isBestSeller').checked);
    formData.append('isUnder5k', document.getElementById('product-isUnder5k').checked);
    formData.append('isUnder10k', document.getElementById('product-isUnder10k').checked);
    const files = document.getElementById('product-images').files;
    for (let file of files) {
      formData.append('images', file);
    }

    try {
      const token = localStorage.getItem('token');
      const url = `${API_BASE_URL}/products${id ? `/${id}` : ''}`;
      console.log(`Submitting product to: ${url}, method: ${id ? 'PUT' : 'POST'}`);
      const response = await fetch(url, {
        method: id ? 'PUT' : 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Product ${id ? 'update' : 'creation'} failed: ${response.status} ${response.statusText} - ${errorText}`);
        throw new Error(`Product ${id ? 'update' : 'creation'} failed: ${response.status} ${response.statusText}`);
      }
      closeProductModal();
      await loadProducts();
      socket.emit('productUpdate');
    } catch (error) {
      console.error('Error saving product:', error);
      showError(`Failed to ${id ? 'update' : 'create'} product. Please try again.`);
    }
  });

  async function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE_URL}/products/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Product deletion failed: ${response.status} ${response.statusText} - ${errorText}`);
        throw new Error(`Product deletion failed: ${response.status} ${response.statusText}`);
      }
      await loadProducts();
      socket.emit('productUpdate');
    } catch (error) {
      console.error('Error deleting product:', error);
      showError('Failed to delete product. Please try again.');
    }
  }

  function editCategory(id, name, icon) {
    openCategoryModal(id, name, icon);
  }

  function editProduct(product) {
    openProductModal(product);
  }
</script>
</body>
</html>