<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bazuka Store | Online Shopping Nigeria - Flash Sales & Deals Under â‚¦10,000</title>
    <!-- (All SEO / OG / JSON-LD meta tags â€“ unchanged) -->
    <meta name="description" content="Shop the best deals on electronics, fashion, and home goods at Bazuka Store, Nigeriaâ€™s top online store. Enjoy flash sales, fast delivery, and prices under â‚¦10,000!">
    <meta name="keywords" content="online shopping Nigeria, Bazuka Store, flash sales Nigeria, cheap electronics Nigeria, fashion deals Nigeria, affordable home goods, Nigeria e-commerce, deals under 10000">
    <meta name="author" content="Bazuka Store">
    <meta name="robots" content="index, follow">
    <meta name="geo.region" content="NG">
    <meta name="geo.placename" content="Nigeria">
    <meta name="geo.position" content="9.0820;8.6753">
    <meta name="ICBM" content="9.0820, 8.6753">
    <link rel="alternate" hreflang="en-ng" href="http://localhost:5000/">
    <link rel="canonical" href="http://localhost:5000/">
    <link rel="sitemap" href="http://localhost:5000/sitemap.xml">
    <meta property="og:title" content="Bazuka Store - Shop Amazing Deals in Nigeria">
    <meta property="og:description" content="Discover flash sales, electronics, fashion, and more at Bazuka Store. Shop now for deals under â‚¦10,000!">
    <meta property="og:image" content="http://localhost:5000/images/fallback-preview-image.jpg" id="og-image">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="http://localhost:5000/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Bazuka Store">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Bazuka Store - Shop Amazing Deals in Nigeria">
    <meta name="twitter:description" content="Discover flash sales, electronics, fashion,and more at Bazuka Store. Shop now for deals under â‚¦10,000!">
    <meta name="twitter:image" content="http://localhost:5000/images/fallback-preview-image.jpg">
    <!-- NEW: PWA Meta Tags -->
    <!-- Theme color for browser UI (matches your primary-purple) -->
    <meta name="theme-color" content="#6C5CE7">
    <!-- Apple touch icon for iOS home screen -->
    <link rel="apple-touch-icon" href="/images/bazukastore.png">
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@graph": [
            {
                "@type": "WebSite",
                "name": "Bazuka Store",
                "url": "http://localhost:5000/",
                "potentialAction": {
                    "@type": "SearchAction",
                    "target": "http://localhost:5000/products.html?search={search_term_string}",
                    "query-input": "required name=search_term_string"
                }
            },
            {
                "@type": "Organization",
                "name": "Bazuka Store",
                "url": "http://localhost:5000/",
                "logo": "http://localhost:5000/images/logo.png",
                "sameAs": [
                    "https://www.facebook.com/bazukastore",
                    "https://www.twitter.com/bazukastore",
                    "https://www.instagram.com/bazukastore"
                ],
                "contactPoint": {
                    "@type": "ContactPoint",
                    "contactType": "Customer Service",
                    "email": "support@bazukastore.com",
                    "url": "http://localhost:5000/contact.html"
                }
            },
            {
                "@type": "OfferCatalog",
                "name": "Bazuka Store Flash Deals",
                "itemListElement": [
                    {
                        "@type": "Offer",
                        "itemOffered": {
                            "@type": "Product",
                            "name": "Flash Sale Products",
                            "description": "Exclusive flash sale items under â‚¦7,500 with limited-time offers.",
                            "url": "http://localhost:5000/products.html?isFlashDeal=true",
                            "image": "http://localhost:5000/images/flash-sale-product.jpg",
                            "offers": {
                                "@type": "Offer",
                                "price": "7500",
                                "priceCurrency": "NGN",
                                "availability": "https://schema.org/InStock"
                            }
                        }
                    },
                    {
                        "@type": "Offer",
                        "itemOffered": {
                            "@type": "Product",
                            "name": "Weekend Deal Products",
                            "description": "Special weekend deals under â‚¦5,000, available every Saturday.",
                            "url": "http://localhost:5000/products.html?isFlashDeal=true",
                            "image": "http://localhost:5000/images/weekend-deal-product.jpg",
                            "offers": {
                                "@type": "Offer",
                                "price": "5000",
                                "priceCurrency": "NGN",
                                "availability": "https://schema.org/InStock"
                            }
                        }
                    }
                ]
            }
        ]
    }
    </script>
    <!-- Preload -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js" as="script">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">
    <link rel="preload" href="https://unpkg.com/lucide@latest" as="script">
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
<style>
    :root {
        --primary-purple: #6C5CE7;
        --secondary-yellow: #FDCB6E;
        --accent-light: #F3F0FF;
        --neutral-gray: #4B4B4B;
        --light-gray: #F5F5F5;
        --alert-red: #FF7675;
        --white: #FFFFFF;
        --text-primary: #1F2937;
        --text-secondary: #6B7280;
    }
    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--accent-light);
        color: var(--text-primary);
        line-height: 1.5;
    }
    /* Ripple */
    .ripple {
        position: relative;
        overflow: hidden;
    }
    .ripple:after {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
        background-repeat: no-repeat;
        background-position: 50%;
        transform: scale(10,10);
        opacity: 0;
        transition: transform .5s, opacity 1s;
    }
    .ripple:active:after {
        transform: scale(0,0);
        opacity: .3;
        transition: 0s;
    }
    /* Toast */
    .toast {
        position: fixed;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        z-index: 50;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        font-size: 0.8125rem;
        font-weight: 500;
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    .toast.success {
        background: #10B981;
        color: white;
    }
    .toast.error {
        background: var(--alert-red);
        color: white;
    }
    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 50;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-content {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        max-width: 90%;
        width: 400px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        transform: scale(0.95);
        opacity: 0;
        transition: all 0.3s ease;
    }
    .modal.show .modal-content {
        transform: scale(1);
        opacity: 1;
    }
    /* Image Modal */
    .image-modal {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 60;
        align-items: center;
        justify-content: center;
    }
    .image-modal.show { display: flex; }
    .image-modal-content img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 0.5rem;
    }
    /* Shimmer */
    .shimmer {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    /* Scrollbar */
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    /* Bottom Nav */
    @media (min-width: 768px) { .bottom-nav { display: none; } }
    /* HERO CARD â€“ FINAL POLISHED LAYOUT */
    .hero-card {
        display: flex;
        flex-direction: column;
        height: 100%;
        padding: 1rem 1rem 0.75rem;
        color: white;
        font-family: 'Inter', sans-serif;
    }
    .hero-card-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
        transform: translateY(-2px);
    }
    .hero-card-avatar {
        width: 2.25rem;
        height: 2.25rem;
        border-radius: 50%;
        margin-right: 0.75rem;
        object-fit: cover;
        border: 2px solid rgba(255,255,255,0.25);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .hero-card-avatar-placeholder {
        width: 2.25rem;
        height: 2.25rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
        color: white;
        margin-right: 0.75rem;
        border: 2px solid rgba(255,255,255,0.25);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .hero-card-name {
        font-weight: 600;
        font-size: 0.875rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 160px;
        line-height: 1.2;
    }
    .hero-card-desc {
        font-size: 0.8125rem;
        line-height: 1.45;
        color: rgba(255, 255, 255, 0.92);
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 0.5rem;
        flex-grow: 1;
        font-weight: 400;
    }
    .hero-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
        font-size: 0.6875rem;
        opacity: 0.85;
        transform: translateY(1px);
    }
    .hero-card-location {
        display: flex;
        align-items: center;
        font-weight: 500;
    }
    .hero-card-location i {
        width: 0.625rem;
        height: 0.625rem;
        margin-right: 0.2rem;
    }
    .hero-card-btn {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(6px);
        color: white;
        font-size: 0.6875rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
        min-width: 60px;
        text-align: center;
    }
    .hero-card-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    /* -------------------------------------------------
       PRODUCT CARD IMAGE â€“ FIXED, RESPONSIVE & CROPPED
       ------------------------------------------------- */
    .product-image-container {
        position: relative;
        height: 160px; /* Uniform card height */
        overflow: hidden;
        border-radius: 0.75rem;
        background: var(--white);
    }
    .product-image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Crops tall/wide images */
        object-position: center; /* Keeps focal point in view */
        transition: transform .3s ease;
    }
    .product-image-container:hover img {
        transform: scale(1.05);
    }
    .product-image-container .absolute {
        pointer-events: none; /* Badges never block clicks */
    }
    /* Optional: Fallback for broken images */
    .product-image-container img[onerror] {
        object-fit: contain;
        background: #f9f9f9;
    }
</style>
</head>
<body class="min-h-screen pb-20 md:pb-0">
    <!-- Header â€“ Updated: Chat to left, Logo centered (with search below on desktop), Cart to right -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <a href="orders.html" class="flex flex-col items-center text-[var(--text-secondary)]" aria-label="Track Order" title="Track Order">
                <i data-feather="truck" class="w-6 h-6"></i>
                <span class="sr-only">Track Order</span>
            </a>
            <!-- Center: Logo + Search (stacked on desktop) -->
            <div class="flex flex-col items-center flex-1 mx-6">
                <div class="text-2xl font-bold text-[var(--primary-purple)] mb-2 md:mb-0">Bazuka<span class="text-[var(--neutral-gray)]">Store</span></div>
            </div>
            <!-- Right: Cart Button (swapped from left, with count badge) -->
            <div class="flex items-center">
                <button class="p-2 rounded-full hover:bg-[var(--light-gray)] ripple cart-button">
                    <div class="relative">
                        <i data-feather="shopping-cart" class="text-[var(--neutral-gray)] w-6 h-6"></i>
                        <span class="absolute -top-1 -right-1 bg-[var(--primary-purple)] text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center" id="top-cart-count">0</span>
                    </div>
                </button>
            </div>
        </div>
    </header>
    <!-- Sign-Up Modal â€“ UPDATED: Added notifications opt-in button -->
    <div id="signup-modal" class="modal">
        <div class="modal-content">
            <i data-feather="x" class="w-6 h-6 text-[var(--neutral-gray)] hover:text-gray-700 absolute top-4 right-4 cursor-pointer" id="close-modal"></i>
            <div class="text-center">
                <i data-feather="user-plus" class="w-12 h-12 text-[var(--primary-purple)] mb-4"></i>
                <p class="text-lg font-semibold mb-2">Welcome to Bazuka Store!</p>
                <p class="text-sm text-[var(--text-secondary)] mb-6">Sign up to save your cart, track orders, and get exclusive deals.</p>
                <!-- NEW: Notifications opt-in button -->
                <button id="notify-button" class="w-full bg-[var(--secondary-yellow)] text-[var(--neutral-gray)] px-5 py-2.5 rounded-full font-medium mb-3 ripple hover:bg-yellow-400">
                    <i data-feather="bell" class="w-4 h-4 inline mr-2"></i>Enable Deal Alerts
                </button>
                <div class="flex flex-col sm:flex-row gap-3">
                    <a href="/register.html" class="bg-[var(--primary-purple)] text-white px-5 py-2.5 rounded-full font-medium hover:bg-purple-700 ripple">Sign Up</a>
                    <a href="/login.html" class="border border-[var(--primary-purple)] text-[var(--primary-purple)] px-5 py-2.5 rounded-full font-medium hover:bg-[var(--accent-light)] ripple">Sign In</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Full-Screen Image Modal -->
    <div id="image-modal" class="image-modal">
        <div class="image-modal-content">
            <span class="image-modal-close text-white text-4xl cursor-pointer">Ã—</span>
            <img id="full-image" src="" alt="Full-screen product image">
            <button class="image-modal-nav prev text-white"><i data-feather="chevron-left" class="w-8 h-8"></i></button>
            <button class="image-modal-nav next text-white"><i data-feather="chevron-right" class="w-8 h-8"></i></button>
        </div>
    </div>
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-4">
        <!-- HERO CAROUSEL â€“ DOTS REMOVED -->
        <div class="relative rounded-2xl overflow-hidden mb-6 h-48 shadow-lg">
            <div class="flex h-full snap-x snap-mandatory overflow-x-auto scroll-smooth scrollbar-hide" id="hero-track">
                <div class="flex-shrink-0 w-full snap-start flex items-center justify-center bg-gradient-to-r from-[var(--primary-purple)] to-purple-600 p-6">
                    <p class="text-white text-sm font-medium">Loading latest requests...</p>
                </div>
            </div>
        </div>
        <!-- Flash Deals, Categories, Best Sellers, Price Tabs â€“ unchanged -->
        <section class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Deal Day</h2>
                <div class="flex items-center text-sm text-[var(--primary-purple)] font-medium">
                    <span class="mr-2">Ends in</span>
                    <div class="flex space-x-1" id="countdown-timer">
                        <div class="bg-[var(--primary-purple)] text-white px-2 py-1 rounded-md text-xs"><span class="countdown-digit">00</span></div>
                        <span>:</span>
                        <div class="bg-[var(--primary-purple)] text-white px-2 py-1 rounded-md text-xs"><span class="countdown-digit">00</span></div>
                        <span>:</span>
                        <div class="bg-[var(--primary-purple)] text-white px-2 py-1 rounded-md text-xs"><span class="countdown-digit">00</span></div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="flash-deals">
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
            </div>
        </section>
        <section class="mb-8">
            <h2 class="text-xl font-bold mb-4">Trending Categories</h2>
            <div class="grid grid-cols-5 gap-3 text-center" id="trending-categories">
                <div class="flex flex-col items-center"><div class="shimmer w-14 h-14 rounded-full mb-2"></div><div class="shimmer w-12 h-3 rounded"></div></div>
                <div class="flex flex-col items-center"><div class="shimmer w-14 h-14 rounded-full mb-2"></div><div class="shimmer w-12 h-3 rounded"></div></div>
                <div class="flex flex-col items-center"><div class="shimmer w-14 h-14 rounded-full mb-2"></div><div class="shimmer w-12 h-3 rounded"></div></div>
                <div class="flex flex-col items-center"><div class="shimmer w-14 h-14 rounded-full mb-2"></div><div class="shimmer w-12 h-3 rounded"></div></div>
                <div class="flex flex-col items-center"><div class="shimmer w-14 h-14 rounded-full mb-2"></div><div class="shimmer w-12 h-3 rounded"></div></div>
            </div>
        </section>
        <section class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Best Sellers</h2>
                <a href="/products.html?isBestSeller=true" class="text-sm text-[var(--primary-purple)] font-medium hover:underline">See all</a>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="best-sellers">
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
            </div>
        </section>
        <section class="mb-8">
            <div class="flex border-b border-gray-200 mb-4">
                <button class="price-tab flex-1 py-3 px-4 text-center font-medium border-b-2 border-[var(--primary-purple)] text-[var(--primary-purple)]" data-range="0-5000" data-flag="isUnder5k">Under â‚¦5k</button>
                <button class="price-tab flex-1 py-3 px-4 text-center font-medium text-[var(--text-secondary)]" data-range="0-10000" data-flag="isUnder10k">Under â‚¦10k</button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="price-tab-products">
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
            </div>
        </section>
        <!-- TOP STORES SECTION â€“ NOW SHOWS PRODUCTS -->
        <section class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Top Sellers</h2>
                <a href="/stores.html" class="text-sm text-[var(--primary-purple)] font-medium hover:underline">See all</a>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="stores">
                <!-- Shimmer placeholders -->
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
                <div class="shimmer h-64 rounded-xl"></div>
            </div>
        </section>
    </main>
    <!-- Floating WhatsApp (unchanged â€“ kept for mobile persistence) -->
    <div class="fixed bottom-24 right-4 z-20">
        <button id="help-button" class="bg-[var(--secondary-yellow)] text-[var(--neutral-gray)] p-3 rounded-full shadow-xl hover:opacity-95 transition-all ripple"
                aria-label="Help & Support" title="Help & Support" onclick="window.location.href='/help.html'">
            <i data-feather="help-circle" class="w-6 h-6"></i>
        </button>
    </div>
    <!-- Bottom Nav â€“ Updated: Moved Orders to right (end position), changed to icon-only "Track Order" with truck icon -->
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 z-10">
        <div class="flex justify-around items-center h-16">
            <a href="index.html" class="flex flex-col items-center text-[var(--primary-purple)]">
                <i data-feather="home" class="w-6 h-6"></i>
                <span class="text-xs mt-1 font-medium">Home</span>
            </a>
            <a href="list-product.html"
               class="flex flex-col items-center text-gray-600 no-underline select-none focus:outline-none active:opacity-80">
              <i data-lucide="store" class="w-6 h-6"></i>
              <span class="text-xs mt-1 font-medium">Sell</span>
            </a>
            <a href="request.html" class="flex flex-col items-center text-[var(--primary-purple)]">
                <div class="w-10 h-10 bg-[var(--primary-purple)] rounded-full flex items-center justify-center shadow-md">
                    <i data-feather="plus" class="w-5 h-5 text-white"></i>
                </div>
                <span class="text-xs mt-1 font-medium">Request</span>
            </a>
          
            <a href="chat-list.html" class="flex flex-col items-center text-[var(--text-secondary)]">
                <i data-feather="message-circle" class="w-6 h-6"></i>
                <span class="text-xs mt-1 font-medium">Chat</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center text-[var(--text-secondary)]">
                <i data-feather="user" class="w-6 h-6"></i>
                <span class="text-xs mt-1 font-medium">Profile</span>
            </a>
        </div>
    </nav>
 <script>
    // Initialize Feather Icons if available
    if (typeof feather !== 'undefined') {
        feather.replace();
    } else {
        console.warn('Feather Icons library not loaded. Icons may not display correctly.');
    }
    // Initialize Lucide Icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    } else {
        console.warn('Lucide Icons library not loaded.');
    }
    const API_BASE_URL = 'http://localhost:5000/api';
    let currentImageIndex = 0;
    let productImages = [];
    const PLACEHOLDER_IMAGE = 'https://via.placeholder.com/150?text=No+Image';
    const FALLBACK_AVATAR = '/images/fallback-avatar.jpg';
    const CDN_FALLBACK_AVATAR = 'https://placehold.co/40x40?text=Avatar';
    // NEW: VAPID public key (replace with your generated key â€“ see Next Steps)
    const VAPID_PUBLIC_KEY = 'YOUR_VAPID_PUBLIC_KEY_HERE'; // e.g., 'BN...'
    // Update Open Graph image dynamically
    async function updateOgImage() {
        try {
            const response = await fetch(`${API_BASE_URL}/public/products?isFlashDeal=true&sort=discount-desc&limit=1`);
            if (!response.ok) throw new Error('Failed to fetch product for OG image');
            const data = await response.json();
            const products = Array.isArray(data) ? data : data.products || [];
            const ogImageMeta = document.getElementById('og-image');
            const twitterImageMeta = document.querySelector('meta[name="twitter:image"]');
            const imageUrl = products[0]?.images?.[0]?.url || 'http://localhost:5000/images/fallback-preview-image.jpg';
            if (ogImageMeta) {
                ogImageMeta.content = imageUrl;
            }
            if (twitterImageMeta) {
                twitterImageMeta.content = imageUrl;
            }
        } catch (error) {
            console.error('Error updating OG image:', error);
            showToast('Failed to update OG image.', 'error');
        }
    }
    // Toast Notification
    function showToast(message, type = 'success', isUpdate = false) {
        const toast = document.createElement('div');
        toast.className = `toast ${type} shadow-lg flex items-center gap-2`; // Flex for button
        toast.innerHTML = `
            <span>${message}</span>
            ${isUpdate ? '<button id="update-btn" class="ml-2 px-2 py-1 text-xs bg-white text-black rounded hover:bg-gray-200">Update</button>' : ''}
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        // NEW: If update toast, add click handler for refresh
        if (isUpdate) {
            const updateBtn = toast.querySelector('#update-btn');
            if (updateBtn) {
                updateBtn.addEventListener('click', () => {
                    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage('skipWaiting');
                        window.location.reload(); // Soft refresh to activate new SW
                    }
                });
            }
        }
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, isUpdate ? 5000 : 2000); // Longer for updates
    }
    // Authentication check
    async function checkAuth() {
        const token = localStorage.getItem('token');
        if (!token) {
            console.warn('No token found in localStorage');
            return false;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/users/profile`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                let errorMessage = 'Session expired. Please sign in again.';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.message || errorMessage;
                } catch (jsonError) {
                    console.error('Error parsing profile response:', jsonError);
                }
                throw new Error(errorMessage);
            }
            return await response.json();
        } catch (error) {
            console.error('Authentication check failed:', error.message);
            localStorage.removeItem('token');
            return false;
        }
    }
    // Full-Screen Image Modal
    function showFullImage(images, index) {
        productImages = images && Array.isArray(images) ? images : [{ url: PLACEHOLDER_IMAGE }];
        currentImageIndex = Math.max(0, Math.min(index, productImages.length - 1));
        const modal = document.getElementById('image-modal');
        const fullImage = document.getElementById('full-image');
        if (!modal || !fullImage) {
            console.error('Image modal elements missing.');
            showToast('Image viewer not available.', 'error');
            return;
        }
        fullImage.src = productImages[currentImageIndex]?.url || PLACEHOLDER_IMAGE;
        fullImage.alt = 'Product Image';
        fullImage.onerror = () => {
            fullImage.src = PLACEHOLDER_IMAGE;
            showToast('Failed to load image', 'error');
        };
        modal.classList.add('show');
        if (typeof feather !== 'undefined') {
            feather.replace();
        } else {
            console.warn('Feather Icons not loaded in showFullImage.');
        }
    }
    function setupImageModal() {
        const modal = document.getElementById('image-modal');
        const closeBtn = document.querySelector('.image-modal-close');
        const prevBtn = document.querySelector('.image-modal-nav.prev');
        const nextBtn = document.querySelector('.image-modal-nav.next');
        if (!modal || !closeBtn || !prevBtn || !nextBtn) {
            console.error('Image modal elements missing.');
            return;
        }
        closeBtn.addEventListener('click', () => {
            modal.classList.remove('show');
        });
        prevBtn.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex - 1 + productImages.length) % productImages.length;
            showFullImage(productImages, currentImageIndex);
        });
        nextBtn.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex + 1) % productImages.length;
            showFullImage(productImages, currentImageIndex);
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('show');
            }
        });
    }
    // Sign-Up Modal functionality â€“ UPDATED: Add notify button handler
    function setupModal() {
        const modal = document.getElementById('signup-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const notifyBtn = document.getElementById('notify-button');
        if (!modal || !closeModalBtn) {
            console.error('Signup modal elements missing.');
            return;
        }
        const token = localStorage.getItem('token');
        if (!token) {
            setTimeout(() => {
                modal.style.display = 'flex';
                modal.classList.add('show');
            }, 5000);
        }
        // NEW: Handle notifications opt-in
        if (notifyBtn) {
            notifyBtn.addEventListener('click', async () => {
                await subscribeToNotifications();
                notifyBtn.textContent = 'Alerts Enabled!'; // Quick UX feedback
                notifyBtn.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }
        closeModalBtn.addEventListener('click', () => {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        });
    }
    // NEW: Subscribe to push notifications
    async function subscribeToNotifications() {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            showToast('Notifications not supported in this browser.', 'error');
            return;
        }
        try {
            const registration = await navigator.serviceWorker.ready;
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('Sign in to enable notifications.', 'error');
                return;
            }
            // Request permission
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                showToast('Notifications blocked. Enable in browser settings.', 'error');
                return;
            }
            // Create subscription with VAPID
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });
            // Send sub to backend (save for user)
            await sendSubscription(subscription, token);
            showToast('Deal alerts enabled! ðŸš¨', 'success');
        } catch (error) {
            console.error('Subscription failed:', error);
            showToast('Failed to enable notifications.', 'error');
        }
    }
    // NEW: Helper to convert VAPID key to Uint8Array
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }
    // NEW: Send subscription to backend
    async function sendSubscription(subscription, token) {
        try {
            const response = await fetch(`${API_BASE_URL}/subscribe`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(subscription)
            });
            if (!response.ok) throw new Error('Failed to save subscription');
        } catch (error) {
            console.error('Error saving subscription:', error);
            showToast('Saved locally â€“ sign in later to sync.', 'success'); // Graceful fallback
            // Optional: Store in localStorage for later sync
            localStorage.setItem('pushSubscription', JSON.stringify(subscription));
        }
    }
    // Countdown timer
    function startCountdown() {
        const countdownTimer = document.getElementById('countdown-timer');
        if (!countdownTimer) {
            console.error('Countdown timer element (#countdown-timer) not found in DOM.');
            showToast('Countdown timer not available.', 'error');
            return;
        }
        const digits = document.querySelectorAll('#countdown-timer .countdown-digit');
        if (digits.length < 3) {
            console.error('Insufficient countdown-digit elements found. Expected at least 3, found:', digits.length);
            showToast('Countdown timer setup incomplete.', 'error');
            return;
        }
        const endTime = new Date();
        endTime.setHours(endTime.getHours() + 2);
        const interval = setInterval(() => {
            const now = new Date();
            const timeLeft = endTime - now;
            if (timeLeft <= 0) {
                digits.forEach(digit => {
                    digit.textContent = '00';
                });
                clearInterval(interval);
                showToast('Flash deal ended!', 'error');
                return;
            }
            const hours = Math.floor(timeLeft / (1000 * 60 * 60)).toString().padStart(2, '0');
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000).toString().padStart(2, '0');
            digits[0].textContent = hours;
            digits[1].textContent = minutes;
            digits[2].textContent = seconds;
            digits.forEach(digit => {
                digit.classList.add('active');
                setTimeout(() => digit.classList.remove('active'), 300);
            });
        }, 1000);
    }
    // HERO CAROUSEL â€“ NO DOTS (CLEAN & AUTO-PLAY)
    const colors = ['#EF4444','#F97316','#F59E0B','#10B981','#3B82F6','#8B5CF6','#D946EF','#EC4899','#14B8A6','#6366F1'];
    const randColor = () => colors[Math.floor(Math.random() * colors.length)];
    const firstLetter = n => n ? n[0].toUpperCase() : 'A';
    const sanitize = t => (t || '').replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ').replace(/\s+/g, ' ').trim();
    async function loadHeroRequests() {
        const track = document.getElementById('hero-track');
        if (!track) return;
        try {
            const res = await fetch(`${API_BASE_URL}/public/requests?limit=20&sort=createdAt-desc`);
            if (!res.ok) throw new Error('Failed');
            const { requests } = await res.json();
            track.innerHTML = '';
            if (!requests || requests.length === 0) {
                track.innerHTML = `<div class="flex-shrink-0 w-full snap-start flex items-center justify-center bg-gradient-to-r from-[var(--primary-purple)] to-purple-600 p-6">
                    <p class="text-white text-sm font-medium">No requests yet. Be the first!</p>
                </div>`;
                return;
            }
            requests.forEach((req) => {
                const name = req.user?.name || 'Anonymous';
                const avatar = req.user?.avatar?.startsWith('http') ? req.user.avatar : FALLBACK_AVATAR;
                const noAvatar = !req.user?.avatar || avatar === FALLBACK_AVATAR;
                const desc = sanitize(req.description);
                const hasLocation = req.location && req.location.trim();
                const slide = document.createElement('div');
                slide.className = 'flex-shrink-0 w-full snap-start bg-gradient-to-r from-[var(--primary-purple)] to-purple-600 p-4 flex items-center';
                slide.innerHTML = `
                    <div class="hero-card max-w-md mx-auto w-full">
                        <div class="hero-card-header">
                            ${noAvatar ? `<div class="hero-card-avatar-placeholder" style="background:${randColor()}">${firstLetter(name)}</div>` :
                            `<img src="${avatar}" alt="${name}" class="hero-card-avatar" onerror="this.src='${CDN_FALLBACK_AVATAR}'">`}
                            <div class="hero-card-name">${name}</div>
                        </div>
                        <p class="hero-card-desc">${desc || 'No description available.'}</p>
                        <div class="hero-card-footer">
                            ${hasLocation ? `<div class="hero-card-location"><i data-feather="map-pin"></i>${req.location}</div>` : '<div></div>'}
                            <a href="/request-details.html?id=${req._id}" class="hero-card-btn ripple">View Details</a>
                        </div>
                    </div>`;
                track.appendChild(slide);
            });
            feather.replace();
            initHeroCarousel();
        } catch (e) {
            console.error(e);
            track.innerHTML = `<div class="flex-shrink-0 w-full snap-start p-6 text-white text-center">Failed to load.</div>`;
        }
    }
    function initHeroCarousel() {
        const track = document.getElementById('hero-track');
        let idx = 0, interval, startX, dragging = false;
        const goToSlide = i => {
            idx = i;
            track.scrollTo({ left: i * track.offsetWidth, behavior: 'smooth' });
            clearInterval(interval);
            interval = setInterval(() => goToSlide((idx + 1) % track.children.length), 8000);
        };
        const start = e => { startX = e.touches?.[0].clientX || e.clientX; dragging = true; track.style.scrollSnapType = 'none'; clearInterval(interval); };
        const move = e => { if (dragging) track.scrollLeft += startX - (startX = e.touches?.[0].clientX || e.clientX); };
        const end = () => { if (dragging) { dragging = false; track.style.scrollSnapType = 'x mandatory'; idx = Math.round(track.scrollLeft / track.offsetWidth); goToSlide(idx); } };
        track.addEventListener('touchstart', start, { passive: true });
        track.addEventListener('touchmove', move, { passive: false });
        track.addEventListener('touchend', end);
        track.addEventListener('mousedown', start);
        track.addEventListener('mousemove', move);
        track.addEventListener('mouseup', end);
        track.addEventListener('mouseleave', end);
        interval = setInterval(() => goToSlide((idx + 1) % track.children.length), 8000);
    }
    // Fetch and render products
    async function fetchProducts(sectionId, query = '') {
        try {
            const container = document.querySelector(sectionId);
            if (!container) {
                throw new Error(`Container ${sectionId} not found in DOM.`);
            }
            let products = [];
            let userListings = [];
            if (sectionId === '#best-sellers') {
                const user = await checkAuth();
                if (user) {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`${API_BASE_URL}/product-submissions/my-listings`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (!response.ok) {
                            let errorMessage = 'Failed to fetch user listings';
                            try {
                                const errorData = await response.json();
                                errorMessage = errorData.error || errorMessage;
                            } catch (jsonError) {
                                errorMessage = 'Network error occurred';
                            }
                            throw new Error(errorMessage);
                        }
                        const data = await response.json();
                        userListings = Array.isArray(data) ? data : data.products || [];
                    } catch (error) {
                        console.error('Error fetching user listings:', error);
                        showToast(`Failed to load your listings: ${error.message}`, 'error');
                    }
                }
                // Fetch public best sellers
                const response = await fetch(`${API_BASE_URL}/public/products?${query}`);
                if (!response.ok) throw new Error('Failed to fetch public best sellers');
                const data = await response.json();
                const publicProducts = Array.isArray(data) ? data : data.products || [];
                // Combine user listings and public best sellers
                products = [...userListings, ...publicProducts];
                // Sort by dealPrice or price (ascending)
                products.sort((a, b) => (a.dealPrice || a.price || 0) - (b.dealPrice || b.price || 0));
                // Mark user listings for badge
                products.forEach(product => {
                    product.isUserListing = userListings.some(userProduct => userProduct._id === product._id);
                });
            } else {
                // Fetch public products for other sections
                const response = await fetch(`${API_BASE_URL}/public/products?${query}`);
                if (!response.ok) throw new Error(`Failed to fetch products for ${sectionId}`);
                const data = await response.json();
                products = Array.isArray(data) ? data : data.products || [];
                if (sectionId === '#flash-deals') {
                    products = products.filter(product => product.isFlashDeal && !product.isBestSeller).slice(0, 4);
                }
            }
            if (products.length === 0) {
                container.innerHTML = '<p class="text-center text-[var(--neutral-gray)]">No products available.</p>';
                return;
            }
            const guestWishlist = JSON.parse(localStorage.getItem('guestWishlist') || '[]');
            const token = localStorage.getItem('token');
            let userWishlist = [];
            if (token) {
                try {
                    const wishlistResponse = await fetch(`${API_BASE_URL}/wishlist/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (wishlistResponse.ok) {
                        const wishlistData = await wishlistResponse.json();
                        userWishlist = Array.isArray(wishlistData) ? wishlistData : wishlistData.items || [];
                    }
                } catch (error) {
                    console.error('Error fetching wishlist:', error);
                }
            }
            container.innerHTML = products.map(product => {
                const isWishlisted = token ? userWishlist.includes(product._id) : guestWishlist.includes(product._id);
                const price = product.isUserListing ? product.dealPrice : product.price;
                const originalPrice = product.isUserListing ? product.price : product.originalPrice;
                const discount = product.discount || (originalPrice && price ? Math.round(((originalPrice - price) / originalPrice) * 100) : null);
                const hasImages = product.images && Array.isArray(product.images) && product.images.length > 0;
                return `
                    <div class="bg-[var(--white)] rounded-xl p-3 shadow-sm product-card transition-all duration-300">
                        <div class="relative product-image-container bg-[var(--white)] rounded-lg mb-2 overflow-hidden cursor-pointer" onclick="showFullImage(${JSON.stringify(product.images || [{ url: PLACEHOLDER_IMAGE }])}, 0)">
                            <a href="/product.html?id=${product._id}">
                                ${hasImages ? `
                                    <img src="${product.images[0].url}" alt="${product.name || 'Product'}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='${PLACEHOLDER_IMAGE}'; showToast('Failed to load image', 'error');">
                                ` : `
                                    <div class="w-full h-full flex items-center justify-center bg-gray-100">
                                        <i data-feather="image" class="w-16 h-16 text-gray-400"></i>
                                    </div>
                                `}
                                ${discount ? `<div class="absolute top-2 left-2 bg-[var(--primary-purple)] text-[var(--white)] text-xs px-2 py-1 rounded">-${discount}%</div>` : ''}
                                ${product.isFlashDeal && !product.isUserListing ? `<div class="absolute top-2 right-2 bg-[var(--alert-red)] text-[var(--white)] text-xs px-2 py-1 rounded flash-deal-tag">Flash Deal</div>` : ''}
                                ${product.isBestSeller && !product.isUserListing ? `<div class="absolute bottom-2 right-2 bg-[var(--secondary-yellow)] text-[var(--neutral-gray)] text-xs px-2 py-1 rounded">Best Seller</div>` : ''}
                                ${product.isUserListing ? `<div class="absolute bottom-2 right-2 bg-[var(--primary-purple)] text-[var(--white)] text-xs px-2 py-1 rounded">My Listing</div>` : ''}
                            </a>
                        </div>
                        <h3 class="text-sm font-medium mb-1 truncate">${product.name || 'Unnamed Product'}</h3>
                        <p class="text-xs text-[var(--neutral-gray)] mb-1 truncate">Shop: ${product.shopName || 'Unknown Shop'}</p>
                        <div class="flex items-center mb-1">
                            <div class="flex text-[var(--secondary-yellow)] text-xs">
                                ${Array.from({ length: 5 }, (_, i) => `
                                    <i data-feather="star" class="w-3 h-3 ${i < Math.round(product.rating || 0) ? 'fill-current' : ''}"></i>
                                `).join('')}
                            </div>
                            <span class="text-xs text-[var(--neutral-gray)] ml-1">(${product.reviews?.length || 0})</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-[var(--primary-purple)] font-bold">â‚¦${price?.toLocaleString() || '0'}</p>
                                ${originalPrice ? `<p class="text-[var(--neutral-gray)] text-xs line-through">â‚¦${originalPrice.toLocaleString()}</p>` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="text-[var(--neutral-gray)] hover:text-[var(--primary-purple)] ripple" onclick="addToCart('${product._id}', 1)">
                                    <i data-feather="shopping-cart" class="w-4 h-4"></i>
                                </button>
                                <button class="text-[var(--neutral-gray)] hover:text-[var(--alert-red)] ripple" onclick="toggleWishlist('${product._id}', this)">
                                    <i data-feather="heart" class="w-4 h-4 ${isWishlisted ? 'fill-current text-[var(--alert-red)]' : ''}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            if (typeof feather !== 'undefined') {
                feather.replace();
            } else {
                console.warn('Feather Icons not loaded in fetchProducts.');
            }
        } catch (error) {
            console.error('Error fetching products:', error);
            showToast('Failed to load products.', 'error');
            document.querySelector(sectionId).innerHTML = '<p class="text-center text-[var(--neutral-gray)]">Failed to load products.</p>';
        }
    }
    // Toggle Wishlist
    async function toggleWishlist(productId, button) {
        const token = localStorage.getItem('token');
        const heartIcon = button.querySelector('svg');
        let guestWishlist = JSON.parse(localStorage.getItem('guestWishlist') || '[]');
        if (token) {
            try {
                const response = await fetch(`${API_BASE_URL}/wishlist/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ productId }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to toggle wishlist');
                }
                const result = await response.json();
                const isWishlisted = result.action === 'added';
                heartIcon.classList.toggle('fill-current', isWishlisted);
                heartIcon.classList.toggle('text-[var(--alert-red)]', isWishlisted);
                showToast(isWishlisted ? 'Added to wishlist!' : 'Removed from wishlist!', 'success');
            } catch (error) {
                console.error('Error toggling wishlist:', error);
                showToast(`Failed to toggle wishlist: ${error.message}`, 'error');
            }
        } else {
            const index = guestWishlist.indexOf(productId);
            if (index === -1) {
                guestWishlist.push(productId);
                heartIcon.classList.add('fill-current', 'text-[var(--alert-red)]');
                showToast('Added to wishlist! Sign in to save.', 'success');
            } else {
                guestWishlist.splice(index, 1);
                heartIcon.classList.remove('fill-current', 'text-[var(--alert-red)]');
                showToast('Removed from wishlist!', 'success');
            }
            localStorage.setItem('guestWishlist', JSON.stringify(guestWishlist));
        }
    }
    // Add to cart
    async function addToCart(productId, quantity) {
        if ('vibrate' in navigator) {
            navigator.vibrate(50);
        }
        const token = localStorage.getItem('token');
        if (token) {
            try {
                const response = await fetch(`${API_BASE_URL}/carts/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ productId, quantity }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to add to cart');
                }
                await fetchCart();
                showToast('Added to cart!', 'success');
            } catch (error) {
                console.error('Error adding to cart:', error);
                showToast(`Failed to add to cart: ${error.message}`, 'error');
            }
        } else {
            const guestCart = JSON.parse(localStorage.getItem('guestCart') || '[]');
            const itemIndex = guestCart.findIndex(item => item.productId === productId);
            if (itemIndex > -1) {
                guestCart[itemIndex].quantity += quantity;
            } else {
                guestCart.push({ productId, quantity });
            }
            localStorage.setItem('guestCart', JSON.stringify(guestCart));
            updateCartCount(guestCart);
            showToast('Added to cart! Sign in to save your cart.', 'success');
        }
    }
    // Update cart count
    function updateCartCount(cart) {
        const count = (cart || []).reduce((sum, item) => sum + (item.quantity || 0), 0);
        document.querySelectorAll('#bottom-cart-count, #top-cart-count').forEach(el => {
            if (el) {
                el.textContent = count;
                el.classList.toggle('animate-bounce', count > 0);
            }
        });
    }
    // Fetch cart
    async function fetchCart() {
        try {
            const token = localStorage.getItem('token');
            if (token) {
                const response = await fetch(`${API_BASE_URL}/carts/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to fetch cart');
                }
                const cart = await response.json();
                updateCartCount(cart.items || []);
            } else {
                const guestCart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                updateCartCount(guestCart);
            }
        } catch (error) {
            console.error('Error fetching cart:', error);
            showToast(`Failed to load cart: ${error.message}`, 'error');
            updateCartCount([]);
        }
    }
    // Fetch and render categories
    async function fetchCategories() {
        try {
            const response = await fetch(`${API_BASE_URL}/public/categories`);
            if (!response.ok) throw new Error('Failed to fetch categories');
            const data = await response.json();
            const categories = Array.isArray(data) ? data : data.categories || [];
            const container = document.querySelector('#trending-categories');
            if (!container) {
                console.error('Trending categories container not found.');
                showToast('Failed to load categories.', 'error');
                return;
            }
            container.innerHTML = categories.map(category => `
                <div class="flex flex-col items-center">
                    <a href="/products.html?category=${category._id}">
                        <div class="w-12 h-12 bg-[var(--white)] rounded-full flex items-center justify-center mb-1 shadow-sm">
                            <i data-feather="${category.icon || 'shopping-bag'}" class="text-[var(--primary-purple)]"></i>
                        </div>
                        <span class="text-xs">${category.name || 'Category'}</span>
                    </a>
                </div>
            `).join('');
            if (typeof feather !== 'undefined') {
                feather.replace();
            } else {
                console.warn('Feather Icons not loaded in fetchCategories.');
            }
        } catch (error) {
            console.error('Error fetching categories:', error);
            showToast('Failed to load categories.', 'error');
            const container = document.querySelector('#trending-categories');
            if (container) {
                container.innerHTML = '<p class="text-center text-[var(--neutral-gray)]">Failed to load categories.</p>'; // Fixed typo from previous
            }
        }
    }
    // TOP STORES â€“ REAL DATA ONLY (NO FAKE RATINGS, NO FAKE REVIEWS)
    async function fetchStores() {
      try {
        const res = await fetch(`${API_BASE_URL}/store-products?limit=12`);
        if (!res.ok) throw new Error('Failed to fetch products');
        const data = await res.json();
        const products = data.products || [];
        const container = document.getElementById('stores');
        if (!container) return;
        if (products.length === 0) {
          container.innerHTML = '<p class="text-center text-[var(--neutral-gray)] py-8">No stores have products yet.</p>';
          return;
        }
        container.innerHTML = products.map(product => {
          const store = product.store;
          const storeName = store?.shopName || 'Unknown Store';
          const storeId = store?._id || '';
         
          const price = product.price || 0;
          const dealPrice = product.dealPrice;
          const discount = dealPrice
            ? Math.round(((price - dealPrice) / price) * 100)
            : null;
          const mainImage = product.images?.[0]?.url || PLACEHOLDER_IMAGE;
          // REAL rating & review count from backend
          const rating = product.rating || 0;
          const reviewCount = product.reviewCount || 0;
          const hasImages = product.images && Array.isArray(product.images) && product.images.length > 0;
          return `
            <div class="bg-[var(--white)] rounded-xl p-3 shadow-sm product-card transition-all duration-300">
             
              <!-- Product Image -->
              <div class="relative product-image-container bg-[var(--white)] rounded-lg mb-2 overflow-hidden cursor-pointer"
                   onclick="showFullImage(${JSON.stringify(product.images || [{ url: PLACEHOLDER_IMAGE }])}, 0)">
                <a href="/product.html?id=${product._id}">
                  ${hasImages ? `
                    <img src="${mainImage}"
                         alt="${product.name}"
                         class="w-full h-full object-cover"
                         loading="lazy"
                         onerror="this.src='${PLACEHOLDER_IMAGE}';">
                  ` : `
                    <div class="w-full h-full flex items-center justify-center bg-gray-100">
                        <i data-feather="image" class="w-16 h-16 text-gray-400"></i>
                    </div>
                  `}
                  ${discount ? `
                    <div class="absolute top-2 left-2 bg-[var(--primary-purple)] text-white text-xs px-2 py-1 rounded">
                      -${discount}%
                    </div>
                  ` : ''}
                  ${store?.verified ? `
                    <div class="absolute top-2 right-2 bg-blue-600 text-white text-xs px-2 py-1 rounded flex items-center gap-1">
                      <i data-feather="check" class="w-3 h-3"></i>
                    </div>
                  ` : ''}
                </a>
              </div>
              <!-- Store Name -->
              <p class="text-xs text-[var(--neutral-gray)] mb-1 truncate">Store: ${storeName}</p>
              <!-- Product Name -->
              <h3 class="text-sm font-medium mb-1 truncate">${product.name}</h3>
              <!-- REAL Rating (only shows if exists) -->
              ${rating > 0 ? `
                <div class="flex items-center mb-1">
                  <div class="flex text-[var(--secondary-yellow)] text-xs">
                    ${Array.from({ length: 5 }, (_, i) => `
                      <i data-feather="star" class="w-3 h-3 ${i < Math.round(rating) ? 'fill-current' : ''}"></i>
                    `).join('')}
                  </div>
                  <span class="text-xs text-[var(--neutral-gray)] ml-1">(${reviewCount})</span>
                </div>
              ` : ''}
              <!-- Price -->
              <div class="flex items-center mb-2">
                <div>
                  <p class="text-[var(--primary-purple)] font-bold">â‚¦${price.toLocaleString()}</p>
                  ${dealPrice ? `
                    <p class="text-[var(--neutral-gray)] text-xs line-through">â‚¦${dealPrice.toLocaleString()}</p>
                  ` : ''}
                </div>
              </div>
              <!-- VIEW STORE BUTTON â€“ UNDER PRICE, FULL WIDTH -->
              <div class="mt-2">
                <a href="/store-details.html?id=${storeId}"
                   class="block w-full bg-[var(--primary-purple)] text-white text-center text-xs font-medium px-4 py-2 rounded-full hover:bg-purple-700 transition-colors ripple">
                  View Store
                </a>
              </div>
            </div>
          `;
        }).join('');
        feather.replace();
      } catch (error) {
        console.error('Error fetching store products:', error);
        const container = document.getElementById('stores');
        if (container) {
          container.innerHTML = `
            <div class="text-center py-8">
              <p class="text-red-500 font-medium">Failed to load stores</p>
              <button onclick="fetchStores()" class="mt-3 text-[var(--primary-purple)] underline text-sm">
                Try Again
              </button>
            </div>
          `;
        }
      }
    }
    // Search functionality
    function setupSearch() {
        const searchInputs = document.querySelectorAll('#desktop-search, #mobile-search');
        searchInputs.forEach(input => {
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const query = e.target.value.trim();
                        if (query) {
                            window.location.href = `/products.html?search=${encodeURIComponent(query)}`;
                        }
                    }
                });
            }
        });
    }
    // Price tab switching
    function setupPriceTabs() {
        const tabs = document.querySelectorAll('.price-tab');
        tabs.forEach(tab => {
            if (tab) {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.classList.remove('border-[var(--primary-purple)]', 'text-[var(--primary-purple)]');
                        t.classList.add('text-[var(--neutral-gray)]');
                    });
                    tab.classList.add('border-[var(--primary-purple)]', 'text-[var(--primary-purple)]');
                    const range = tab.getAttribute('data-range');
                    const flag = tab.getAttribute('data-flag');
                    fetchProducts('#price-tab-products', `priceRange=${range}&${flag}=true`);
                });
            }
        });
    }
    // Ripple effect for buttons
    function setupRippleEffect() {
        document.querySelectorAll('.ripple').forEach(button => {
            if (button) {
                button.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    this.style.setProperty('--x', x + 'px');
                    this.style.setProperty('--y', y + 'px');
                });
            }
        });
    }
    // Cart navigation
    function setupCartNavigation() {
        document.querySelectorAll('.cart-button').forEach(button => {
            if (button) {
                button.addEventListener('click', () => {
                    window.location.href = '/cart.html';
                });
            }
        });
    }
    // NEW: Service Worker Registration & Update Handling
    // Registers SW if supported; handles updates with user prompt via your toast.
    async function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                console.log('SW registered:', registration.scope);
                // Listen for updatefound - new SW version detected (e.g., after deploy)
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    if (newWorker) {
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                // NEW content available - prompt user
                                if (navigator.serviceWorker.controller) {
                                    // Already active SW exists, so this is an update
                                    showToast('New deals & features ready! Tap to update.', 'success', true); // true = update toast
                                }
                            }
                        });
                    }
                });
                // Handle message from SW (e.g., skipWaiting after user taps update)
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data === 'skipWaiting') {
                        registration.waiting?.postMessage('skipWaiting');
                    }
                });
            } catch (error) {
                console.error('SW registration failed:', error);
                showToast('Offline mode unavailable.', 'error');
            }
        }
    }
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        startCountdown();
        loadHeroRequests();
        fetchProducts('#flash-deals', 'isFlashDeal=true&sort=discount-desc&limit=4');
        fetchProducts('#best-sellers', 'isBestSeller=true&sort=price-asc');
        fetchProducts('#price-tab-products', 'priceRange=0-5000&isUnder5k=true');
        fetchCategories();
        fetchCart();
        fetchStores(); // Now shows PRODUCTS
        setupSearch();
        setupPriceTabs();
        setupRippleEffect();
        setupCartNavigation();
        setupModal();
        setupImageModal();
        updateOgImage();
        // NEW: Register SW after DOM load
        registerServiceWorker();
    });
</script>
</body>
</html>