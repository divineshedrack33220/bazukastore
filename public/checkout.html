<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Bazuka Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-purple: #6C5CE7;
            --secondary-yellow: #FDCB6E;
            --accent-light: #F3F0FF;
            --neutral-gray: #4B4B4B;
            --light-gray: #F5F5F5;
            --alert-red: #FF7675;
            --white: #FFFFFF;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--accent-light);
            color: var(--neutral-gray);
        }
        
        .payment-method {
            transition: all 0.3s ease;
        }
        
        .payment-method.active {
            border-color: var(--primary-purple);
            background-color: rgba(108, 92, 231, 0.05);
        }
        
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple:after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10,10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        
        .ripple:active:after {
            transform: scale(0,0);
            opacity: .3;
            transition: 0s;
        }
        
        @media (min-width: 768px) {
            .bottom-nav {
                display: none;
            }
        }

        .checkout-loader {
            animation: shimmer 1.5s infinite linear;
            background: linear-gradient(to right, #f6f6f6 0%, #edeef1 20%, #f6f6f6 40%, #f6f6f6 100%);
            background-size: 200% 100%;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Added loader styles for the submit button */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="min-h-screen pb-24 md:pb-0">
    <!-- Top Navigation -->
    <header class="bg-[var(--white)] shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <button onclick="history.back()" class="p-2 rounded-full hover:bg-[var(--light-gray)] ripple">
                <i data-feather="arrow-left" class="text-[var(--neutral-gray)]"></i>
            </button>
            <h1 class="text-lg font-bold">Checkout</h1>
            <div class="flex items-center space-x-4" id="auth-links"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-4 md:px-6 lg:max-w-4xl">
        <!-- Loader -->
        <div id="checkout-loader" class="space-y-4 hidden">
            <div class="bg-[var(--white)] rounded-xl p-4 shadow-sm">
                <div class="h-6 w-1/2 bg-gray-200 rounded checkout-loader mb-3"></div>
                <div class="bg-[var(--light-gray)] p-3 rounded-lg space-y-2">
                    <div class="h-4 w-1/3 bg-gray-200 rounded checkout-loader"></div>
                    <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    <div class="h-4 w-3/4 bg-gray-200 rounded checkout-loader"></div>
                </div>
            </div>
            <div class="bg-[var(--white)] rounded-xl p-4 shadow-sm">
                <div class="h-6 w-1/2 bg-gray-200 rounded checkout-loader mb-3"></div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <div class="h-4 w-1/2 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                    <div class="flex justify-between">
                        <div class="h-4 w-1/2 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                    <div class="flex justify-between">
                        <div class="h-4 w-1/2 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3 mt-3">
                    <div class="flex justify-between">
                        <div class="h-4 w-1/3 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                    <div class="flex justify-between">
                        <div class="h-4 w-1/3 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                </div>
            </div>
            <div class="bg-[var(--white)] rounded-xl p-4 shadow-sm">
                <div class="h-6 w-1/2 bg-gray-200 rounded checkout-loader mb-3"></div>
                <div class="space-y-2">
                    <div class="h-12 w-full bg-gray-200 rounded-lg checkout-loader"></div>
                    <div class="h-12 w-full bg-gray-200 rounded-lg checkout-loader"></div>
                    <div class="h-12 w-full bg-gray-200 rounded-lg checkout-loader"></div>
                </div>
            </div>
            <div class="h-10 w-full bg-gray-200 rounded-full checkout-loader"></div>
        </div>

        <!-- Checkout Content -->
        <div id="checkout-content">
            <!-- Delivery Address -->
            <div class="bg-[var(--white)] rounded-xl p-4 shadow-sm mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="font-bold flex items-center">
                        <i data-feather="map-pin" class="w-4 h-4 mr-2 text-[var(--primary-purple)]"></i>
                        Delivery Address
                    </h2>
                    <button class="text-sm text-[var(--primary-purple)] ripple" id="change-address">Change</button>
                </div>
                <div class="bg-[var(--light-gray)] p-3 rounded-lg" id="address-container">
                    <p class="text-sm text-[var(--neutral-gray)]">No address selected. <a href="/saved-addresses.html" class="text-[var(--primary-purple)]">Add one</a>.</p>
                </div>
            </div>
            
            <!-- Order Summary -->
            <div class="bg-[var(--white)] rounded-xl p-4 shadow-sm mb-6 md:max-w-md md:mx-auto" id="order-summary">
                <h2 class="font-bold mb-3">Order Summary</h2>
                <div class="space-y-3 mb-3" id="order-items"></div>
                <div class="border-t border-gray-200 pt-3 mb-3" id="summary-details">
                    <div class="flex justify-between">
                        <span class="text-[var(--neutral-gray)]">Subtotal</span>
                        <span class="font-medium" id="subtotal">₦0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-[var(--neutral-gray)]">Delivery Fee</span>
                        <span class="font-medium" id="delivery-fee">₦0</span>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3">
                    <div class="flex justify-between">
                        <span class="font-bold">Total</span>
                        <span class="font-bold text-[var(--primary-purple)]" id="total">₦0</span>
                    </div>
                </div>
            </div>
            
            <!-- Payment Method -->
            <div class="bg-[var(--white)] rounded-xl p-4 shadow-sm mb-6">
                <h2 class="font-bold mb-3">Payment Method</h2>
                <div class="space-y-3" id="payment-methods">
                    <div class="payment-method border rounded-lg p-3 flex items-center cursor-pointer active" data-payment-type="bank_transfer">
                        <div class="w-8 h-8 bg-[rgba(108,92,231,0.1)] rounded-full flex items-center justify-center mr-3">
                            <i data-feather="repeat" class="text-[var(--primary-purple)] w-4 h-4"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium">Bank Transfer</p>
                            <p class="text-xs text-[var(--neutral-gray)]">Pay via bank transfer to our account</p>
                        </div>
                        <i data-feather="check" class="text-[var(--primary-purple)] w-5 h-5"></i>
                    </div>
                </div>
            </div>
            
            <!-- Order Notes -->
            <div class="bg-[var(--white)] rounded-xl p-4 shadow-sm mb-6">
                <h2 class="font-bold mb-3">Order Notes (Optional)</h2>
                <textarea class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-[var(--primary-purple)] focus:border-transparent" 
                          rows="3" placeholder="Any special instructions for delivery..." id="order-notes"></textarea>
            </div>
            
            <!-- Place Order Button -->
            <button class="w-full py-3 bg-[var(--primary-purple)] text-[var(--white)] rounded-full font-bold ripple mb-6 hover:bg-purple-600" id="place-order">
                Place Order
            </button>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-[var(--white)] shadow-lg border-t border-gray-200 z-10">
        <div class="flex justify-around items-center h-16">
            <a href="index.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <i data-feather="home" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Home</span>
            </a>
            <a href="categories.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <i data-feather="grid" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Categories</span>
            </a>
            <a href="cart.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <div class="relative">
                    <i data-feather="shopping-cart" class="w-6 h-6"></i>
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-[var(--primary-purple)] text-[var(--white)] text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center">0</span>
                </div>
                <span class="text-xs mt-1">Cart</span>
            </a>
            <a href="orders.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <i data-feather="package" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Orders</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <i data-feather="user" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Profile</span>
            </a>
        </div>
    </nav>

    <!-- Bank Details Modal -->
    <div id="bank-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-[var(--white)] rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="font-bold text-lg mb-4">Bank Transfer Details</h3>
            <div class="space-y-3">
                <p><strong>Account Number:</strong> 6500447330</p>
                <p><strong>Bank:</strong> Providus Bank</p>
                <p><strong>Account Name:</strong> David Akinwumi</p>
                <p class="text-sm text-[var(--neutral-gray)]">Please make the transfer of <span id="transfer-amount">₦0</span> to the above account. You'll need to upload proof of payment in the next step.</p>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-bank-details" class="px-4 py-2 bg-gray-200 text-[var(--neutral-gray)] rounded-lg ripple">Cancel</button>
                <button id="proceed-to-proof" class="px-4 py-2 bg-[var(--primary-purple)] text-[var(--white)] rounded-lg ripple">Proceed</button>
            </div>
        </div>
    </div>

    <!-- Proof of Payment Modal -->
    <div id="proof-payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-[var(--white)] rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="font-bold text-lg mb-4">Upload Proof of Payment</h3>
            <div class="space-y-3">
                <input type="file" id="payment-proof" accept="image/*,.pdf" class="w-full p-2 border border-gray-300 rounded-lg">
                <p class="text-sm text-[var(--neutral-gray)]">Upload a screenshot or PDF of your payment confirmation (max 5MB).</p>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-proof" class="px-4 py-2 bg-gray-200 text-[var(--neutral-gray)] rounded-lg ripple">Cancel</button>
                <button id="submit-order" class="px-4 py-2 bg-[var(--primary-purple)] text-[var(--white)] rounded-lg ripple flex items-center justify-center">
                    <span id="submit-order-text">Submit Order</span>
                    <span id="submit-order-loader" class="loader hidden"></span>
                </button>
            </div>
        </div>
    </div>

    <script>
        feather.replace();

        const API_BASE_URL = 'https://bazukastore.com/api';
        const DELIVERY_FEE = 5000;

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html?redirect=checkout';
                return false;
            }
            return true;
        }

        // Update authentication UI
        function setupAuthUI() {
            const authLinks = document.getElementById('auth-links');
            if (!authLinks) {
                console.error('Auth links element not found');
                return;
            }
            authLinks.innerHTML = '';
        }

        // Show loader
        function showShimmer() {
            const checkoutLoader = document.getElementById('checkout-loader');
            const checkoutContent = document.getElementById('checkout-content');
            if (!checkoutLoader || !checkoutContent) {
                console.error('Loader elements not found:', {
                    checkoutLoader: !!checkoutLoader,
                    checkoutContent: !!checkoutContent
                });
                const main = document.querySelector('main');
                if (main) {
                    main.innerHTML = '<p class="text-center text-[var(--neutral-gray)]">Loading checkout...</p>';
                }
                return;
            }
            checkoutLoader.classList.remove('hidden');
            checkoutContent.classList.add('hidden');
        }

        // Hide loader
        function hideShimmer() {
            const checkoutLoader = document.getElementById('checkout-loader');
            const checkoutContent = document.getElementById('checkout-content');
            if (!checkoutLoader || !checkoutContent) {
                console.error('Loader elements not found:', {
                    checkoutLoader: !!checkoutLoader,
                    checkoutContent: !!checkoutContent
                });
                return;
            }
            checkoutLoader.classList.add('hidden');
            checkoutContent.classList.remove('hidden');
        }

        // Fetch and render checkout data with retry
        async function fetchCheckoutData(retryCount = 0, maxRetries = 2) {
            console.log('Fetching checkout data, checking DOM elements:', {
                checkoutLoader: !!document.getElementById('checkout-loader'),
                checkoutContent: !!document.getElementById('checkout-content')
            });
            showShimmer();
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/checkout`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
                if (response.status === 401) {
                    console.warn('Unauthorized access, clearing token');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html?redirect=checkout';
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.message || response.status;
                    if (errorData.message === 'Cart is empty') {
                        hideShimmer();
                        alert('Your cart is empty. Please add items to proceed with checkout.');
                        window.location.href = '/cart.html';
                        return;
                    }
                    throw new Error(`Failed to fetch checkout data: ${errorMessage}`);
                }
                const data = await response.json();
                hideShimmer();
                renderCheckoutData(data);
                updateCartCount(data.cart);
                window.checkoutData = data;
            } catch (error) {
                console.error('Error fetching checkout data:', error.message);
                if (retryCount < maxRetries && !error.message.includes('401') && !error.message.includes('Cart is empty')) {
                    console.log(`Retrying fetchCheckoutData (${retryCount + 1}/${maxRetries})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return fetchCheckoutData(retryCount + 1, maxRetries);
                }
                hideShimmer();
                const main = document.querySelector('main');
                if (main) {
                    main.innerHTML = '<p class="text-center text-[var(--neutral-gray)]">Failed to load checkout data. Please try again.</p>';
                }
            }
        }

        // Render checkout data
        async function renderCheckoutData(data) {
            const addressContainer = document.getElementById('address-container');
            if (!addressContainer) {
                console.error('Address container not found');
                return;
            }
            if (data.defaultAddress) {
                addressContainer.innerHTML = `
                    <p class="font-medium">${data.defaultAddress.label || 'Default Address'}</p>
                    <p class="text-sm text-[var(--neutral-gray)]">${data.defaultAddress.phone || 'N/A'}</p>
                    <p class="text-sm text-[var(--neutral-gray)] mt-1">${data.defaultAddress.street}, ${data.defaultAddress.city}, ${data.defaultAddress.state || 'Lagos'}, Nigeria</p>
                `;
            } else {
                addressContainer.innerHTML = '<p class="text-sm text-[var(--neutral-gray)]">No address selected. <a href="/saved-addresses.html" class="text-[var(--primary-purple)]">Add one</a>.</p>';
            }

            const orderItems = document.getElementById('order-items');
            const summaryDetails = document.getElementById('summary-details');
            const totalContainer = document.getElementById('total');
            const transferAmount = document.getElementById('transfer-amount');
            if (!orderItems || !summaryDetails || !totalContainer || !transferAmount) {
                console.error('Order summary elements not found:', {
                    orderItems: !!orderItems,
                    summaryDetails: !!summaryDetails,
                    totalContainer: !!totalContainer,
                    transferAmount: !!transferAmount
                });
                return;
            }
            orderItems.innerHTML = data.cart.length > 0 ? data.cart.map(item => `
                <div class="flex justify-between">
                    <span class="text-[var(--neutral-gray)]">${item.product.name} × ${item.quantity}</span>
                    <span class="font-medium">₦${(item.product.price * item.quantity).toLocaleString()}</span>
                </div>
            `).join('') : '<p class="text-[var(--neutral-gray)]">No items in cart.</p>';

            summaryDetails.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-[var(--neutral-gray)]">Subtotal</span>
                    <span class="font-medium" id="subtotal">₦${data.summary.subtotal.toLocaleString()}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[var(--neutral-gray)]">Delivery Fee</span>
                    <span class="font-medium" id="delivery-fee">₦${data.summary.deliveryFee.toLocaleString()}</span>
                </div>
            `;
            totalContainer.textContent = `₦${data.summary.total.toLocaleString()}`;
            transferAmount.textContent = `₦${data.summary.total.toLocaleString()}`;

            // Fetch bank details dynamically
            try {
                const bankDetailsResponse = await fetch(`${API_BASE_URL}/orders/bank-details`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    },
                });
                if (bankDetailsResponse.ok) {
                    const bankDetails = await bankDetailsResponse.json();
                    document.getElementById('bank-details-modal').querySelector('div.space-y-3').innerHTML = `
                        <p><strong>Account Number:</strong> ${bankDetails.accountNumber}</p>
                        <p><strong>Bank:</strong> ${bankDetails.bank}</p>
                        <p><strong>Account Name:</strong> ${bankDetails.accountName}</p>
                        <p class="text-sm text-[var(--neutral-gray)]">Please make the transfer of <span id="transfer-amount">₦${data.summary.total.toLocaleString()}</span> to the above account. You'll need to upload proof of payment in the next step.</p>
                    `;
                }
            } catch (error) {
                console.error('Error fetching bank details:', error.message);
            }

            feather.replace();
        }

        // Update cart count
        function updateCartCount(cart) {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            const cartCount = document.getElementById('cart-count');
            if (cartCount) {
                cartCount.textContent = count;
                cartCount.classList.toggle('animate-bounce', count > 0);
            }
        }

        // Handle order submission with retry
        async function placeOrder(retryCount = 0, maxRetries = 2) {
            try {
                const token = localStorage.getItem('token');
                const addressContainer = document.getElementById('address-container');
                if (!addressContainer.querySelector('p.font-medium')) {
                    alert('Please select a delivery address.');
                    window.location.href = '/saved-addresses.html';
                    return;
                }

                const selectedPayment = document.querySelector('.payment-method.active');
                if (!selectedPayment || selectedPayment.getAttribute('data-payment-type') !== 'bank_transfer') {
                    alert('Please select bank transfer as the payment method.');
                    return;
                }

                // Show bank details modal
                const bankDetailsModal = document.getElementById('bank-details-modal');
                if (!bankDetailsModal) {
                    console.error('Bank details modal not found');
                    alert('Error: Payment modal not available. Please try again.');
                    return;
                }
                bankDetailsModal.classList.remove('hidden');
            } catch (error) {
                console.error('Error in placeOrder:', error.message);
                if (retryCount < maxRetries && !error.message.includes('401')) {
                    console.log(`Retrying placeOrder (${retryCount + 1}/${maxRetries})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return placeOrder(retryCount + 1, maxRetries);
                }
                alert(`Failed to initiate order: ${error.message}`);
            }
        }

        // Submit order with proof of payment
        async function submitOrder(retryCount = 0, maxRetries = 2) {
            const submitButton = document.getElementById('submit-order');
            const submitText = document.getElementById('submit-order-text');
            const submitLoader = document.getElementById('submit-order-loader');

            // Show loading state
            if (submitButton && submitText && submitLoader) {
                submitButton.disabled = true;
                submitText.textContent = 'Submitting...';
                submitLoader.classList.remove('hidden');
            }

            try {
                const token = localStorage.getItem('token');
                const paymentProof = document.getElementById('payment-proof').files[0];
                const orderNotes = document.getElementById('order-notes').value.trim();

                if (!paymentProof) {
                    alert('Please upload proof of payment.');
                    // Reset loading state
                    if (submitButton && submitText && submitLoader) {
                        submitButton.disabled = false;
                        submitText.textContent = 'Submit Order';
                        submitLoader.classList.add('hidden');
                    }
                    return;
                }

                if (paymentProof.size > 5 * 1024 * 1024) {
                    alert('Proof of payment file size exceeds 5MB.');
                    // Reset loading state
                    if (submitButton && submitText && submitLoader) {
                        submitButton.disabled = false;
                        submitText.textContent = 'Submit Order';
                        submitLoader.classList.add('hidden');
                    }
                    return;
                }

                // Fetch default address ID
                const addressResponse = await fetch(`${API_BASE_URL}/addresses`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
                if (addressResponse.status === 401) {
                    console.warn('Unauthorized access, clearing token');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html?redirect=checkout';
                    // Reset loading state
                    if (submitButton && submitText && submitLoader) {
                        submitButton.disabled = false;
                        submitText.textContent = 'Submit Order';
                        submitLoader.classList.add('hidden');
                    }
                    return;
                }
                if (!addressResponse.ok) {
                    const errorData = await addressResponse.json().catch(() => ({}));
                    throw new Error(`Failed to fetch addresses: ${errorData.message || addressResponse.status}`);
                }
                const addresses = await addressResponse.json();
                const defaultAddress = addresses.find(addr => addr.isDefault);
                if (!defaultAddress) {
                    alert('Please select a delivery address.');
                    window.location.href = '/saved-addresses.html';
                    // Reset loading state
                    if (submitButton && submitText && submitLoader) {
                        submitButton.disabled = false;
                        submitText.textContent = 'Submit Order';
                        submitLoader.classList.add('hidden');
                    }
                    return;
                }

                // Upload proof of payment
                const formData = new FormData();
                formData.append('proof', paymentProof);

                const uploadResponse = await fetch(`${API_BASE_URL}/orders/upload-proof`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                    body: formData,
                });
                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json().catch(() => ({}));
                    throw new Error(`Failed to upload proof: ${errorData.message || uploadResponse.status}`);
                }
                const uploadResult = await uploadResponse.json();
                const proofUrl = uploadResult.url;

                // Create order
                const orderResponse = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        addressId: defaultAddress._id,
                        paymentMethod: 'Bank Transfer',
                        orderNotes,
                        paymentProof: proofUrl,
                    }),
                });
                if (orderResponse.status === 401) {
                    console.warn('Unauthorized access, clearing token');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html?redirect=checkout';
                    // Reset loading state
                    if (submitButton && submitText && submitLoader) {
                        submitButton.disabled = false;
                        submitText.textContent = 'Submit Order';
                        submitLoader.classList.add('hidden');
                    }
                    return;
                }
                if (!orderResponse.ok) {
                    const errorData = await orderResponse.json().catch(() => ({}));
                    throw new Error(`Failed to place order: ${errorData.message || orderResponse.status}`);
                }

                const order = await orderResponse.json();
                alert(`Order placed successfully! Order #${order.orderNumber}. We will verify your payment and update you soon.`);
                window.location.href = '/orders.html';
            } catch (error) {
                console.error('Error submitting order:', error.message);
                if (retryCount < maxRetries && !error.message.includes('401')) {
                    console.log(`Retrying submitOrder (${retryCount + 1}/${maxRetries})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return submitOrder(retryCount + 1, maxRetries);
                }
                alert(`Failed to submit order: ${error.message}`);
            } finally {
                // Reset loading state
                if (submitButton && submitText && submitLoader) {
                    submitButton.disabled = false;
                    submitText.textContent = 'Submit Order';
                    submitLoader.classList.add('hidden');
                }
            }
        }

        // Modal event listeners
        function setupModalEvents() {
            const bankDetailsModal = document.getElementById('bank-details-modal');
            const proofPaymentModal = document.getElementById('proof-payment-modal');
            const cancelBankDetails = document.getElementById('cancel-bank-details');
            const proceedToProof = document.getElementById('proceed-to-proof');
            const cancelProof = document.getElementById('cancel-proof');
            const submitOrderBtn = document.getElementById('submit-order');

            if (!bankDetailsModal || !proofPaymentModal || !cancelBankDetails || !proceedToProof || !cancelProof || !submitOrderBtn) {
                console.error('Modal elements not found');
                return;
            }

            cancelBankDetails.addEventListener('click', () => {
                bankDetailsModal.classList.add('hidden');
            });

            proceedToProof.addEventListener('click', () => {
                bankDetailsModal.classList.add('hidden');
                proofPaymentModal.classList.remove('hidden');
            });

            cancelProof.addEventListener('click', () => {
                proofPaymentModal.classList.add('hidden');
                document.getElementById('payment-proof').value = '';
            });

            submitOrderBtn.addEventListener('click', submitOrder);
        }

        // Ripple effect for buttons
        function setupRippleEffect() {
            document.querySelectorAll('.ripple').forEach(button => {
                button.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    this.style.setProperty('--x', x + 'px');
                    this.style.setProperty('--y', y + 'px');
                });
            });
        }

        // Monitor DOM changes
        function setupDOMObserver() {
            const main = document.querySelector('main');
            if (!main) {
                console.error('Main element not found for DOM observer');
                return;
            }
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (!document.getElementById('checkout-loader')) {
                        console.warn('checkout-loader was removed from DOM', mutation);
                    }
                });
            });
            observer.observe(main, { childList: true, subtree: true });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking initial elements:', {
                checkoutLoader: !!document.getElementById('checkout-loader'),
                checkoutContent: !!document.getElementById('checkout-content')
            });
            if (checkAuth()) {
                setupAuthUI();
                fetchCheckoutData();
                setupRippleEffect();
                document.getElementById('place-order').addEventListener('click', placeOrder);
                document.getElementById('change-address').addEventListener('click', () => {
                    window.location.href = '/saved-addresses.html';
                });
                setupModalEvents();
                setupDOMObserver();
            }
        });
    </script>
</body>
</html>