<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - Bazuka Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #13AA52;      /* MongoDB Green */
            --secondary-dark: #001E2B;     /* Dark background tone */
            --accent-light: #E8F5E9;       /* Light mint background */
            --neutral-gray: #4B5563;       /* Neutral gray for text */
            --light-gray: #F1F3F2;         /* Subtle light gray */
            --alert-red: #EF4444;          /* Keep red for errors */
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--accent-light);
            color: var(--secondary-dark);
        }
        
        .cart-item {
            transition: all 0.3s ease;
        }
        
        .cart-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple:after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10,10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        
        .ripple:active:after {
            transform: scale(0,0);
            opacity: .3;
            transition: 0s;
        }
        
        @media (min-width: 768px) {
            .bottom-nav {
                display: none;
            }
        }

        /* Loader Styles */
        .cart-loader {
            animation: shimmer 1.5s infinite linear;
            background: linear-gradient(to right, #f6f6f6 0%, #edeef1 20%, #f6f6f6 40%, #f6f6f6 100%);
            background-size: 200% 100%;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="min-h-screen pb-24 md:pb-0">
    <!-- Top Navigation -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <button onclick="history.back()" class="p-2 rounded-full hover:bg-gray-100 ripple">
                <i data-feather="arrow-left" class="text-[var(--neutral-gray)]"></i>
            </button>
            
            <h1 class="text-lg font-bold" id="cart-title">My Cart (0)</h1>
            
            <div class="flex items-center space-x-4" id="auth-links"></div>
        </div>
    </header>

    <!-- Sign-Up Prompt -->
    <div id="signup-prompt" class="bg-[var(--light-gray)] p-4 text-center text-sm text-[var(--neutral-gray)] mb-4 mx-4 rounded-lg hidden">
        Save your cart and proceed to checkout! <a href="/register.html" class="text-[var(--primary-green)] hover:text-[var(--primary-green)]">Create an account</a> or <a href="/login.html" class="text-[var(--primary-green)] hover:text-[var(--primary-green)]">log in</a>.
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 md:px-6 lg:max-w-4xl">
        <!-- Cart Items Loader -->
        <div id="cart-items-loader" class="space-y-4 hidden">
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="flex">
                    <div class="w-20 h-20 bg-gray-200 rounded-lg mr-4 cart-loader"></div>
                    <div class="flex-1 space-y-2">
                        <div class="h-5 w-3/4 bg-gray-200 rounded cart-loader"></div>
                        <div class="h-4 w-1/2 bg-gray-200 rounded cart-loader"></div>
                        <div class="flex items-center justify-between">
                            <div class="h-5 w-1/4 bg-gray-200 rounded cart-loader"></div>
                            <div class="flex items-center border border-gray-200 rounded-full">
                                <div class="h-6 w-8 bg-gray-200 rounded-l-full cart-loader"></div>
                                <div class="h-6 w-8 bg-gray-200 cart-loader"></div>
                                <div class="h-6 w-8 bg-gray-200 rounded-r-full cart-loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="flex">
                    <div class="w-20 h-20 bg-gray-200 rounded-lg mr-4 cart-loader"></div>
                    <div class="flex-1 space-y-2">
                        <div class="h-5 w-3/4 bg-gray-200 rounded cart-loader"></div>
                        <div class="h-4 w-1/2 bg-gray-200 rounded cart-loader"></div>
                        <div class="flex items-center justify-between">
                            <div class="h-5 w-1/4 bg-gray-200 rounded cart-loader"></div>
                            <div class="flex items-center border border-gray-200 rounded-full">
                                <div class="h-6 w-8 bg-gray-200 rounded-l-full cart-loader"></div>
                                <div class="h-6 w-8 bg-gray-200 cart-loader"></div>
                                <div class="h-6 w-8 bg-gray-200 rounded-r-full cart-loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart Items -->
        <div class="space-y-4 mb-6" id="cart-items"></div>
        
        <!-- Order Summary -->
        <div class="bg-white rounded-xl p-4 shadow-sm mb-6 md:max-w-md md:mx-auto" id="order-summary">
            <div id="summary-loader" class="space-y-3 hidden">
                <div class="h-6 w-1/2 bg-gray-200 rounded cart-loader"></div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <div class="h-4 w-1/3 bg-gray-200 rounded cart-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded cart-loader"></div>
                    </div>
                    <div class="flex justify-between">
                        <div class="h-4 w-1/3 bg-gray-200 rounded cart-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded cart-loader"></div>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3">
                    <div class="flex justify-between">
                        <div class="h-5 w-1/4 bg-gray-200 rounded cart-loader"></div>
                        <div class="h-5 w-1/4 bg-gray-200 rounded cart-loader"></div>
                    </div>
                </div>
                <div class="h-10 w-full bg-gray-200 rounded-full cart-loader"></div>
            </div>
            <div id="summary-content">
                <h2 class="font-bold mb-3">Order Summary</h2>
                <div class="space-y-2 mb-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600" id="subtotal-label">Subtotal (0 items)</span>
                        <span class="font-medium" id="subtotal">₦0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Delivery Fee</span>
                        <span class="font-medium" id="delivery-fee">₦0</span>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3 mb-4">
                    <div class="flex justify-between">
                        <span class="font-bold">Total</span>
                        <span class="font-bold text-[var(--primary-green)]" id="total">₦0</span>
                    </div>
                </div>
                <button class="w-full py-3 bg-[var(--primary-green)] text-white rounded-full font-bold ripple" id="checkout-button" disabled>
                    Proceed to Checkout
                </button>
            </div>
        </div>
        
        <!-- Continue Shopping -->
        <div class="text-center">
            <button class="text-[var(--primary-green)] font-medium flex items-center justify-center mx-auto ripple" onclick="window.location.href='/index.html'">
                <i data-feather="arrow-left" class="w-4 h-4 mr-1"></i>
                Continue Shopping
            </button>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 z-10">
        <div class="flex justify-around items-center h-16">
            <a href="index.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <i data-feather="home" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Home</span>
            </a>
            <a href="categories.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <i data-feather="grid" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Categories</span>
            </a>
            <a href="cart.html" class="flex flex-col items-center text-[var(--primary-green)]">
                <div class="relative">
                    <i data-feather="shopping-cart" class="w-6 h-6"></i>
                    <span class="absolute -top-1 -right-1 bg-[var(--primary-green)] text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center" id="cart-count">0</span>
                </div>
                <span class="text-xs mt-1">Cart</span>
            </a>
            <a href="orders.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <i data-feather="package" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Orders</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <i data-feather="user" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Profile</span>
            </a>
        </div>
    </nav>

    <script>
        feather.replace();

        const API_BASE_URL = 'http://localhost:5000/api';
        const DELIVERY_FEE = 5000;

        // Check authentication and update UI
        function setupAuthUI() {
            const token = localStorage.getItem('token');
            const signupPrompt = document.getElementById('signup-prompt');
            const authLinks = document.getElementById('auth-links');

            if (!signupPrompt || !authLinks) {
                console.error('Signup prompt or auth links element not found');
                return;
            }

            // Hide signup prompt for authenticated users, keep auth-links empty
            signupPrompt.classList.toggle('hidden', !!token);
            authLinks.innerHTML = '';
        }

        // Show loader
        function showShimmer() {
            const cartLoader = document.getElementById('cart-items-loader');
            const summaryLoader = document.getElementById('summary-loader');
            const summaryContent = document.getElementById('summary-content');
            const cartItems = document.getElementById('cart-items');

            if (!cartLoader || !summaryLoader || !summaryContent || !cartItems) {
                console.error('Loader elements not found:', {
                    cartLoader: !!cartLoader,
                    summaryLoader: !!summaryLoader,
                    summaryContent: !!summaryContent,
                    cartItems: !!cartItems
                });
                if (cartItems) {
                    cartItems.innerHTML = '<p class="text-center text-[var(--neutral-gray)]">Loading cart...</p>';
                }
                return;
            }

            cartLoader.classList.remove('hidden');
            summaryLoader.classList.remove('hidden');
            summaryContent.classList.add('hidden');
            cartItems.innerHTML = '';
        }

        // Hide loader
        function hideShimmer() {
            const cartLoader = document.getElementById('cart-items-loader');
            const summaryLoader = document.getElementById('summary-loader');
            const summaryContent = document.getElementById('summary-content');

            if (!cartLoader || !summaryLoader || !summaryContent) {
                console.error('Loader elements not found:', {
                    cartLoader: !!cartLoader,
                    summaryLoader: !!summaryLoader,
                    summaryContent: !!summaryContent
                });
                return;
            }

            cartLoader.classList.add('hidden');
            summaryLoader.classList.add('hidden');
            summaryContent.classList.remove('hidden');
        }

        // Fetch and render cart with retry
        async function fetchCart(retryCount = 0, maxRetries = 2) {
            console.log('Fetching cart, checking DOM elements:', {
                cartLoader: !!document.getElementById('cart-items-loader'),
                summaryLoader: !!document.getElementById('summary-loader'),
                summaryContent: !!document.getElementById('summary-content'),
                cartItems: !!document.getElementById('cart-items')
            });
            showShimmer();
            try {
                const token = localStorage.getItem('token');
                let cart = [];
                if (token) {
                    const response = await fetch(`${API_BASE_URL}/carts/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                        },
                    });
                    if (response.status === 401) {
                        console.warn('Unauthorized access, clearing token');
                        localStorage.removeItem('token');
                        setupAuthUI();
                        return;
                    }
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Failed to fetch cart: ${errorData.message || response.status} - ${await response.text()}`);
                    }
                    const cartData = await response.json();
                    cart = cartData.items || [];
                } else {
                    cart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                    if (cart.length > 0) {
                        const productIds = cart.map(item => item.productId);
                        const response = await fetch(`${API_BASE_URL}/public/products?ids=${productIds.join(',')}`);
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(`Failed to fetch product details: ${errorData.message || response.status} - ${await response.text()}`);
                        }
                        const products = await response.json();
                        cart = cart.map(item => {
                            const product = products.find(p => p._id === item.productId) || { _id: item.productId, name: 'Unknown Product', price: 0, images: [], specifications: {} };
                            return { product, quantity: item.quantity };
                        });
                    }
                }
                hideShimmer();
                renderCart(cart);
                updateCartCount(cart);
                updateOrderSummary(cart);
            } catch (error) {
                console.error('Error fetching cart:', error.message);
                if (retryCount < maxRetries && !error.message.includes('401')) {
                    console.log(`Retrying fetchCart (${retryCount + 1}/${maxRetries})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return fetchCart(retryCount + 1, maxRetries);
                }
                hideShimmer();
                const cartItems = document.querySelector('#cart-items');
                if (cartItems) {
                    cartItems.innerHTML = '<p class="text-center text-[var(--neutral-gray)]">Failed to load cart. Please try again.</p>';
                }
                updateCartCount([]);
                updateOrderSummary([]);
            }
        }

        // Render cart items
        function renderCart(cart) {
            const container = document.querySelector('#cart-items');
            if (!container) {
                console.error('Cart items container not found');
                return;
            }
            if (!cart || cart.length === 0) {
                container.innerHTML = '<p class="text-center text-[var(--neutral-gray)]">Your cart is empty.</p>';
                const checkoutButton = document.querySelector('#checkout-button');
                const cartTitle = document.querySelector('#cart-title');
                if (checkoutButton) checkoutButton.disabled = true;
                if (cartTitle) cartTitle.textContent = `My Cart (0)`;
                return;
            }
            container.innerHTML = cart.map(item => `
                <div class="bg-white rounded-xl p-4 shadow-sm cart-item">
                    <div class="flex">
                        <div class="w-20 h-20 bg-white rounded-lg mr-4 overflow-hidden">
                            <img src="${item.product.images[0]?.url || 'https://via.placeholder.com/80'}" alt="${item.product.name}" class="w-full h-full object-contain">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h3 class="font-medium truncate">${item.product.name}</h3>
                                <button class="text-[var(--neutral-gray)] hover:text-[var(--alert-red)] ripple" onclick="removeFromCart('${item.product._id}')">
                                    <i data-feather="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mb-2">${item.product.specifications?.color || 'N/A'}</p>
                            <div class="flex items-center justify-between">
                                <p class="text-[var(--primary-green)] font-bold">₦${item.product.price.toLocaleString()}</p>
                                <div class="flex items-center border border-gray-200 rounded-full">
                                    <button class="px-2 py-1 text-[var(--neutral-gray)] hover:text-[var(--primary-green)] ripple" onclick="updateQuantity('${item.product._id}', ${item.quantity - 1})">
                                        <i data-feather="minus" class="w-3 h-3"></i>
                                    </button>
                                    <span class="px-2 text-sm">${item.quantity}</span>
                                    <button class="px-2 py-1 text-[var(--neutral-gray)] hover:text-[var(--primary-green)] ripple" onclick="updateQuantity('${item.product._id}', ${item.quantity + 1})">
                                        <i data-feather="plus" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            feather.replace();
            const checkoutButton = document.querySelector('#checkout-button');
            const cartTitle = document.querySelector('#cart-title');
            if (checkoutButton) checkoutButton.disabled = false;
            if (cartTitle) cartTitle.textContent = `My Cart (${cart.length})`;
        }

        // Update cart count
        function updateCartCount(cart) {
            const count = (cart || []).reduce((sum, item) => sum + (item.quantity || 0), 0);
            document.querySelectorAll('#cart-count, #bottom-cart-count').forEach(el => {
                if (el) {
                    el.textContent = count;
                    el.classList.toggle('animate-bounce', count > 0);
                }
            });
        }

        // Update order summary
        function updateOrderSummary(cart) {
            const subtotal = (cart || []).reduce((sum, item) => sum + (item.product.price || 0) * (item.quantity || 0), 0);
            const itemCount = (cart || []).length;
            const total = subtotal + (itemCount > 0 ? DELIVERY_FEE : 0);

            const subtotalLabel = document.querySelector('#subtotal-label');
            const subtotalEl = document.querySelector('#subtotal');
            const deliveryFee = document.querySelector('#delivery-fee');
            const totalEl = document.querySelector('#total');

            if (subtotalLabel) subtotalLabel.textContent = `Subtotal (${itemCount} ${itemCount === 1 ? 'item' : 'items'})`;
            if (subtotalEl) subtotalEl.textContent = `₦${subtotal.toLocaleString()}`;
            if (deliveryFee) deliveryFee.textContent = `₦${(itemCount > 0 ? DELIVERY_FEE : 0).toLocaleString()}`;
            if (totalEl) totalEl.textContent = `₦${total.toLocaleString()}`;
        }

        // Update cart quantity with retry
        async function updateQuantity(productId, quantity, retryCount = 0, maxRetries = 2) {
            if (quantity < 1) {
                removeFromCart(productId);
                return;
            }
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const response = await fetch(`${API_BASE_URL}/carts/add`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                        body: JSON.stringify({ productId, quantity }),
                    });
                    if (response.status === 401) {
                        console.warn('Unauthorized access, clearing token');
                        localStorage.removeItem('token');
                        setupAuthUI();
                        return;
                    }
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Failed to update cart: ${errorData.message || response.status} - ${await response.text()}`);
                    }
                    await fetchCart();
                } catch (error) {
                    console.error('Error updating quantity:', error.message);
                    if (retryCount < maxRetries && !error.message.includes('401')) {
                        console.log(`Retrying updateQuantity (${retryCount + 1}/${maxRetries})...`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return updateQuantity(productId, quantity, retryCount + 1, maxRetries);
                    }
                }
            } else {
                const guestCart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                const itemIndex = guestCart.findIndex(item => item.productId === productId);
                if (itemIndex > -1) {
                    guestCart[itemIndex].quantity = quantity;
                } else {
                    guestCart.push({ productId, quantity });
                }
                localStorage.setItem('guestCart', JSON.stringify(guestCart));
                await fetchCart();
            }
        }

        // Remove item from cart with retry
        async function removeFromCart(productId, retryCount = 0, maxRetries = 2) {
            showShimmer();
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const response = await fetch(`${API_BASE_URL}/carts/remove`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                        body: JSON.stringify({ productId }),
                    });
                    if (response.status === 401) {
                        console.warn('Unauthorized access, clearing token');
                        localStorage.removeItem('token');
                        setupAuthUI();
                        return;
                    }
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Failed to remove item: ${errorData.message || response.status} - ${await response.text()}`);
                    }
                    await fetchCart();
                } catch (error) {
                    console.error('Error removing item:', error.message);
                    if (retryCount < maxRetries && !error.message.includes('401')) {
                        console.log(`Retrying removeFromCart (${retryCount + 1}/${maxRetries})...`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return removeFromCart(productId, retryCount + 1, maxRetries);
                    }
                    hideShimmer();
                }
            } else {
                const guestCart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                const updatedCart = guestCart.filter(item => item.productId !== productId);
                localStorage.setItem('guestCart', JSON.stringify(updatedCart));
                await fetchCart();
            }
        }

        // Handle checkout
        function setupCheckout() {
            const checkoutButton = document.querySelector('#checkout-button');
            if (checkoutButton) {
                checkoutButton.addEventListener('click', () => {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        window.location.href = '/login.html?redirect=checkout';
                    } else {
                        window.location.href = '/checkout.html';
                    }
                });
            }
        }

        // Ripple effect for buttons
        function setupRippleEffect() {
            document.querySelectorAll('.ripple').forEach(button => {
                button.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    this.style.setProperty('--x', x + 'px');
                    this.style.setProperty('--y', y + 'px');
                });
            });
        }

        // Monitor DOM changes
        function setupDOMObserver() {
            const main = document.querySelector('main');
            if (!main) {
                console.error('Main element not found for DOM observer');
                return;
            }
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (!document.getElementById('cart-items-loader')) {
                        console.warn('cart-items-loader was removed from DOM', mutation);
                    }
                });
            });
            observer.observe(main, { childList: true, subtree: true });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking initial elements:', {
                cartLoader: !!document.getElementById('cart-items-loader'),
                summaryLoader: !!document.getElementById('summary-loader'),
                summaryContent: !!document.getElementById('summary-content'),
                cartItems: !!document.getElementById('cart-items')
            });
            setupAuthUI();
            fetchCart();
            setupRippleEffect();
            setupCheckout();
            setupDOMObserver();
        });
    </script>
</body>
</html>