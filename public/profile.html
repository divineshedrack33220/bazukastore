<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bazuka Store - My Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #13AA52;      /* MongoDB Green */
            --secondary-dark: #001E2B;     /* Dark background tone */
            --accent-light: #E8F5E9;       /* Light mint background */
            --neutral-gray: #4B5563;       /* Neutral gray for text */
            --light-gray: #F1F3F2;         /* Subtle light gray */
            --alert-red: #EF4444;          /* Keep red for errors */
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--accent-light);
            color: var(--secondary-dark);
        }
        
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple:after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10,10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        
        .ripple:active:after {
            transform: scale(0,0);
            opacity: .3;
            transition: 0s;
        }
        
        .profile-card:hover, .account-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .faq-item {
            cursor: pointer;
        }
        
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .faq-item.active .faq-answer {
            max-height: 200px;
        }
        
        .faq-item.active .chevron {
            transform: rotate(180deg);
        }

        .toast {
            position: fixed;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            z-index: 50;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-size: 0.75rem;
            line-height: 1rem;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background-color: #10B981;
            color: white;
        }

        .toast.error {
            background-color: var(--alert-red);
            color: white;
        }

        .shimmer {
            position: relative;
            overflow: hidden;
            background-color: var(--light-gray);
            border-radius: 4px;
        }

        .shimmer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        @media (min-width: 768px) {
            .bottom-nav {
                display: none;
            }
            .account-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .container {
                max-width: 1200px;
            }
        }
    </style>
</head>
<body class="min-h-screen pb-20 md:pb-0">
    <!-- Top Navigation -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center">
                <div class="text-2xl font-bold text-[var(--primary-green)]">Bazuka<span class="text-[var(--secondary-dark)]">Store</span></div>
            </div>
            <div class="flex items-center space-x-4">
                <button class="p-2 rounded-full hover:bg-gray-100 ripple">
                    <i data-feather="bell" class="w-6 h-6 text-[var(--neutral-gray)]"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-4">
        <!-- Profile Section -->
        <section class="mb-8">
            <h2 class="text-xl font-bold mb-4">My Account</h2>
            <div class="profile-card bg-white rounded-xl p-4 shadow-sm mb-4 transition-all duration-300">
                <div class="flex items-center mb-4" id="profile-content">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mr-4 overflow-hidden shimmer" id="profile-picture-container">
                        <img id="profile-picture" class="w-full h-full object-cover hidden" alt="Profile Picture">
                        <i data-feather="user" class="w-8 h-8 text-[var(--primary-green)] hidden" id="profile-icon"></i>
                    </div>
                    <div>
                        <div class="h-6 w-32 mb-2 shimmer" id="user-name"></div>
                        <div class="h-4 w-48 mb-1 shimmer" id="user-email"></div>
                        <div class="h-4 w-36 shimmer" id="user-phone"></div>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row md:space-x-4">
                    <button class="w-full md:w-1/2 py-2 bg-[var(--primary-green)] text-white rounded-full font-medium ripple mb-2 md:mb-0" id="edit-profile-btn">Edit Profile</button>
                </div>
            </div>
        </section>

        <!-- Edit Profile Modal -->
        <div class="modal" id="edit-profile-modal">
            <div class="modal-content">
                <h3 class="text-lg font-bold mb-4">Edit Profile</h3>
                <div id="modal-error" class="hidden text-sm text-[var(--alert-red)] mb-2"></div>
                <div class="mb-4">
                    <label for="modal-name" class="block text-sm font-medium mb-1">Name</label>
                    <input type="text" id="modal-name" class="w-full py-2 px-4 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[var(--primary-green)] focus:border-transparent" placeholder="Enter your name">
                </div>
                <div class="mb-4">
                    <label for="modal-phone" class="block text-sm font-medium mb-1">Phone Number</label>
                    <input type="tel" id="modal-phone" class="w-full py-2 px-4 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[var(--primary-green)] focus:border-transparent" placeholder="Enter your phone number">
                </div>
                <div class="flex space-x-4">
                    <button class="w-1/2 py-2 bg-[var(--primary-green)] text-white rounded-full font-medium ripple" id="save-profile-btn">Save</button>
                    <button class="w-1/2 py-2 bg-gray-200 text-[var(--neutral-gray)] rounded-full font-medium ripple" id="cancel-profile-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Account Options -->
        <section class="mb-8">
            <h2 class="text-xl font-bold mb-4">Account Options</h2>
            <div class="account-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <a href="/saved-addresses.html" class="account-option bg-white rounded-xl p-4 shadow-sm flex items-center transition-all duration-300">
                    <i data-feather="map-pin" class="w-6 h-6 text-[var(--primary-green)] mr-3"></i>
                    <div>
                        <p class="text-sm font-medium">Saved Addresses</p>
                        <p class="text-xs text-gray-500">Manage delivery addresses</p>
                    </div>
                </a>
                <a href="/payment-methods.html" class="account-option bg-white rounded-xl p-4 shadow-sm flex items-center transition-all duration-300">
                    <i data-feather="credit-card" class="w-6 h-6 text-[var(--primary-green)] mr-3"></i>
                    <div>
                        <p class="text-sm font-medium">Payment Methods</p>
                        <p class="text-xs text-gray-500">Add or edit payment options</p>
                    </div>
                </a>
                <a href="/wishlist.html" class="account-option bg-white rounded-xl p-4 shadow-sm flex items-center transition-all duration-300">
                    <i data-feather="heart" class="w-6 h-6 text-[var(--primary-green)] mr-3"></i>
                    <div>
                        <p class="text-sm font-medium">Wishlist</p>
                        <p class="text-xs text-gray-500">View your saved items</p>
                    </div>
                </a>
                <a href="/account-security.html" class="account-option bg-white rounded-xl p-4 shadow-sm flex items-center transition-all duration-300">
                    <i data-feather="lock" class="w-6 h-6 text-[var(--primary-green)] mr-3"></i>
                    <div>
                        <p class="text-sm font-medium">Account Security</p>
                        <p class="text-xs text-gray-500">Manage password & security</p>
                    </div>
                </a>
                <button class="account-option bg-white rounded-xl p-4 shadow-sm flex items-center transition-all duration-300" id="logout-btn">
                    <i data-feather="log-out" class="w-6 h-6 text-[var(--primary-green)] mr-3"></i>
                    <div>
                        <p class="text-sm font-medium">Logout</p>
                        <p class="text-xs text-gray-500">Sign out of your account</p>
                    </div>
                </button>
            </div>
        </section>

        <!-- Support Information -->
        <section class="mb-8">
            <h2 class="text-xl font-bold mb-4">Support Information</h2>
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <p class="text-sm font-medium mb-2">Need Help?</p>
                <p class="text-sm text-gray-500 mb-4">Contact our support team for assistance with your orders, returns, or any inquiries.</p>
                <div class="flex items-center mb-2">
                    <i data-feather="phone" class="w-5 h-5 text-[var(--primary-green)] mr-3"></i>
                    <p class="text-sm">+234 800 123 4567</p>
                </div>
                <div class="flex items-center mb-2">
                    <i data-feather="mail" class="w-5 h-5 text-[var(--primary-green)] mr-3"></i>
                    <p class="text-sm">support@BazukaStore.com</p>
                </div>
                <a href="/chat.html" class="inline-block py-2 px-4 bg-green-500 text-white rounded-full font-medium ripple mt-2">Live Chat</a>
            </div>
        </section>

        <!-- FAQ Section -->
        <section class="mb-8">
            <h2 class="text-xl font-bold mb-4">Frequently Asked Questions</h2>
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="faq-item mb-4">
                    <p class="text-sm font-medium flex items-center justify-between">How can I track my order? <i data-feather="chevron-down" class="w-5 h-5 chevron"></i></p>
                    <div class="faq-answer text-sm text-gray-500 mt-2">
                        You can track your order by visiting the "My Orders" section in your account. Click on an active order to view its tracking details, including the current status and estimated delivery date.
                    </div>
                </div>
                <div class="faq-item mb-4">
                    <p class="text-sm font-medium flex items-center justify-between">What is your return policy? <i data-feather="chevron-down" class="w-5 h-5 chevron"></i></p>
                    <div class="faq-answer text-sm text-gray-500 mt-2">
                        We offer a 7-day return policy for eligible items. To initiate a return, go to "My Orders," select the order, and follow the return instructions. Ensure the item is unused and in its original packaging.
                    </div>
                </div>
                <div class="faq-item">
                    <p class="text-sm font-medium flex items-center justify-between">How do I update my payment method? <i data-feather="chevron-down" class="w-5 h-5 chevron"></i></p>
                    <div class="faq-answer text-sm text-gray-500 mt-2">
                        Navigate to "Payment Methods" in your account to add, edit, or remove payment options. We support various methods, including cards and mobile payments.
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Floating WhatsApp Button -->
    <div class="fixed bottom-24 right-4 z-20">
        <button class="bg-green-500 text-white p-3 rounded-full shadow-lg hover:bg-green-600 transition-colors ripple" onclick="window.location.href='/chat.html'">
            <i data-feather="message-circle" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 z-10">
        <div class="flex justify-around items-center h-16">
            <a href="/index.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <i data-feather="home" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Home</span>
            </a>
            <a href="/categories.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <i data-feather="grid" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Categories</span>
            </a>
            <a href="/cart.html" class="flex flex-col items-center text-[var(--neutral-gray)] cart-button">
                <div class="relative">
                    <i data-feather="shopping-cart" class="w-6 h-6"></i>
                    <span class="absolute -top-1 -right-1 bg-[var(--primary-green)] text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center" id="bottom-cart-count">0</span>
                </div>
                <span class="text-xs mt-1">Cart</span>
            </a>
            <a href="/orders.html" class="flex flex-col items-center text-[var(--neutral-gray)]">
                <i data-feather="package" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Orders</span>
            </a>
            <a href="/profile.html" class="flex flex-col items-center text-[var(--primary-green)]">
                <i data-feather="user" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Profile</span>
            </a>
        </div>
    </nav>

    <script>
        feather.replace();

        const API_BASE_URL = 'https://bazukastore.com/api';

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type} shadow-lg`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 100);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { toast.remove(); }, 300); }, 2000);
        }

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('Please log in to view your profile', 'error');
                setTimeout(() => { window.location.href = '/login.html?redirect=profile'; }, 2000);
                return false;
            }
            return true;
        }

        async function mergeGuestCart() {
            try {
                const token = localStorage.getItem('token');
                const guestCart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                if (guestCart.length > 0) {
                    const response = await fetch(`${API_BASE_URL}/carts/merge`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                        body: JSON.stringify({ cart: guestCart }),
                    });
                    if (!response.ok) {
                        let errorMessage = 'Failed to merge cart';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorMessage;
                        } catch (jsonError) {
                            errorMessage = 'Network error occurred';
                        }
                        throw new Error(errorMessage);
                    }
                    localStorage.removeItem('guestCart');
                    showToast('Guest cart merged successfully', 'success');
                }
            } catch (error) {
                console.error('Error merging guest cart:', error);
                showToast(`Failed to merge guest cart: ${error.message}`, 'error');
            }
        }

        async function fetchCart() {
            try {
                const token = localStorage.getItem('token');
                let cart = [];
                if (token) {
                    const response = await fetch(`${API_BASE_URL}/carts/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) {
                        let errorMessage = 'Failed to fetch cart';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorMessage;
                        } catch (jsonError) {
                            errorMessage = 'Network error occurred';
                        }
                        throw new Error(errorMessage);
                    }
                    cart = (await response.json()).items || [];
                } else {
                    cart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                }
                updateCartCount(cart);
            } catch (error) {
                console.error('Error fetching cart:', error);
                showToast(`Failed to load cart: ${error.message}`, 'error');
            }
        }

        async function fetchProfile() {
            if (!checkAuth()) return;
            try {
                const token = localStorage.getItem('token');
                const [userResponse, cartItems] = await Promise.all([
                    fetch(`${API_BASE_URL}/users/profile`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetchCart()
                ]);
                if (!userResponse.ok) {
                    let errorMessage = 'Failed to fetch profile';
                    try {
                        const errorData = await userResponse.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (jsonError) {
                        errorMessage = 'Network error occurred';
                    }
                    throw new Error(errorMessage);
                }
                const user = await userResponse.json();
                renderProfile(user);
                await mergeGuestCart();
            } catch (error) {
                console.error('Error fetching profile:', error);
                document.querySelector('#profile-content').innerHTML = '<p class="text-center text-[var(--neutral-gray)]">Failed to load profile. Please try again.</p>';
                showToast(`Failed to load profile: ${error.message}`, 'error');
            }
        }

        function renderProfile(user) {
            const profileContent = document.querySelector('#profile-content');
            profileContent.innerHTML = `
                <div class="flex items-center mb-4">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mr-4 overflow-hidden" id="profile-picture-container">
                        <img id="profile-picture" class="w-full h-full object-cover ${user.picture ? '' : 'hidden'}" alt="Profile Picture" src="${user.picture || ''}">
                        <i data-feather="user" class="w-8 h-8 text-[var(--primary-green)] ${user.picture ? 'hidden' : ''}" id="profile-icon"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold" id="user-name">${user.name || 'User'}</h3>
                        <p class="text-sm text-gray-500" id="user-email">${user.email || 'No email provided'}</p>
                        <p class="text-sm text-gray-500" id="user-phone">${user.phone || 'No phone number provided'}</p>
                    </div>
                </div>
            `;
            document.querySelector('#modal-name').value = user.name || '';
            document.querySelector('#modal-phone').value = user.phone || '';
            feather.replace();
        }

        function showModal() {
            document.querySelector('#edit-profile-modal').classList.add('show');
            document.querySelector('#modal-error').classList.add('hidden');
        }

        function hideModal() {
            document.querySelector('#edit-profile-modal').classList.remove('show');
            document.querySelector('#modal-error').classList.add('hidden');
        }

        async function saveProfile() {
            const name = document.querySelector('#modal-name').value.trim();
            const phone = document.querySelector('#modal-phone').value.trim();
            const modalError = document.querySelector('#modal-error');

            if (!name || !phone) {
                modalError.textContent = 'Name and phone number are required.';
                modalError.classList.remove('hidden');
                return;
            }

            const phoneRegex = /^\+?\d{10,15}$/;
            if (!phoneRegex.test(phone)) {
                modalError.textContent = 'Please enter a valid phone number (10-15 digits).';
                modalError.classList.remove('hidden');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/users/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ name, phone }),
                });
                if (!response.ok) {
                    let errorMessage = 'Failed to update profile';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (jsonError) {
                        errorMessage = 'Network error occurred';
                    }
                    throw new Error(errorMessage);
                }
                const user = await response.json();
                renderProfile(user);
                hideModal();
                showToast('Profile updated successfully', 'success');
            } catch (error) {
                console.error('Error updating profile:', error);
                modalError.textContent = `Failed to update profile: ${error.message}`;
                modalError.classList.remove('hidden');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                showToast('Logged out successfully', 'success');
                setTimeout(() => { window.location.href = '/login.html'; }, 2000);
            }
        }

        function updateCartCount(cartItems) {
            const count = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            document.querySelector('#bottom-cart-count').textContent = count;
            document.querySelector('#bottom-cart-count').classList.toggle('animate-bounce', count > 0);
        }

        function setupCartNavigation() {
            document.querySelectorAll('.cart-button').forEach(button => {
                button.addEventListener('click', () => {
                    if ('vibrate' in navigator) {
                        navigator.vibrate(50);
                    }
                    window.location.href = '/cart.html';
                });
            });
        }

        function setupRippleEffect() {
            document.querySelectorAll('.ripple').forEach(button => {
                button.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    this.style.setProperty('--x', x + 'px');
                    this.style.setProperty('--y', y + 'px');
                });
            });
        }

        function setupFaqToggle() {
            document.querySelectorAll('.faq-item').forEach(item => {
                item.addEventListener('click', () => {
                    item.classList.toggle('active');
                    feather.replace();
                });
            });
        }

        function setupModal() {
            document.querySelector('#edit-profile-btn').addEventListener('click', showModal);
            document.querySelector('#save-profile-btn').addEventListener('click', saveProfile);
            document.querySelector('#cancel-profile-btn').addEventListener('click', hideModal);
        }

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            setTimeout(() => {
                if (checkAuth()) {
                    fetchProfile();
                    setupCartNavigation();
                    setupRippleEffect();
                    setupFaqToggle();
                    setupModal();
                    document.querySelector('#logout-btn').addEventListener('click', logout);
                }
            }, 100);
        });
    </script>
</body>
</html>