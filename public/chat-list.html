<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Referrer-Policy" content="no-referrer-when-downgrade" />
  <title>Chats | Bazuka Store</title>
  <meta name="description" content="View your chat conversations on Bazuka Store." />
  <meta name="keywords" content="chats, messaging, Bazuka Store, Nigeria e-commerce" />
  <meta name="author" content="Bazuka Store" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://bazukastore.com/chat-list.html" />

  <!-- Tailwind CDN (JIT mode) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: 'var(--primary)',
            secondary: 'var(--secondary)',
            surface: 'var(--surface)',
            bg: 'var(--bg)',
            text: 'var(--text)',
            'text-muted': 'var(--text-muted)',
            error: 'var(--error)',
            border: 'var(--border)',
            hover: 'var(--hover)',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          borderRadius: {
            'xl': 'var(--radius)',
          },
        },
      },
    }
  </script>

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <!-- Custom CSS Variables + Minimal Overrides -->
  <style>
    :root {
      --primary: #4F46E5;
      --secondary: #FBBF24;
      --bg: #F8FAFC;
      --surface: #FFFFFF;
      --text: #1F2937;
      --text-muted: #000000;
      --error: #EF4444;
      --border: #E5E7EB;
      --hover: #F1F5F9;
      --radius: 12px;
    }

    /* Grid Loader */
    .lds-grid {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 80px;
    }
    .lds-grid div {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: currentColor;
      animation: lds-grid 1.2s linear infinite;
    }
    .lds-grid div:nth-child(1) { top: 8px; left: 8px; animation-delay: 0s; }
    .lds-grid div:nth-child(2) { top: 8px; left: 32px; animation-delay: -0.4s; }
    .lds-grid div:nth-child(3) { top: 8px; left: 56px; animation-delay: -0.8s; }
    .lds-grid div:nth-child(4) { top: 32px; left: 8px; animation-delay: -0.4s; }
    .lds-grid div:nth-child(5) { top: 32px; left: 32px; animation-delay: -0.8s; }
    .lds-grid div:nth-child(6) { top: 32px; left: 56px; animation-delay: -1.2s; }
    .lds-grid div:nth-child(7) { top: 56px; left: 8px; animation-delay: -0.8s; }
    .lds-grid div:nth-child(8) { top: 56px; left: 32px; animation-delay: -1.2s; }
    .lds-grid div:nth-child(9) { top: 56px; left: 56px; animation-delay: -1.6s; }
    @keyframes lds-grid {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Shimmer */
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
  </style>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.5.0/dist/socket.io.min.js"></script>
</head>
<body class="bg-bg text-text font-sans min-h-screen pb-24 overflow-x-hidden">

  <!-- Loader -->
  <div id="loader" class="fixed inset-0 bg-bg flex items-center justify-center z-50 transition-opacity duration-400">
    <div class="lds-grid" style="color: var(--primary);">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 bg-surface border-b border-border z-40">
    <div class="max-w-[375px] mx-auto px-4 flex items-center justify-between h-14">
      <button id="back-button" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-hover transition" aria-label="Go back">
        <i data-feather="arrow-left" class="w-5 h-5"></i>
      </button>
      <h1 class="text-xl font-bold">Chats</h1>
      <div class="w-10"></div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-[375px] mx-auto px-4 py-4">
    <section id="active-chats"></section>
  </main>

  <!-- FAB -->
  <button id="fab" class="fixed bottom-6 right-4 w-14 h-14 bg-primary rounded-full flex items-center justify-center shadow-lg hover:shadow-xl active:scale-95 transition z-50">
    <i data-feather="message-circle" class="w-6 h-6 text-white"></i>
  </button>

  <!-- Bottom Sheet -->
  <div id="bottom-sheet" class="fixed inset-x-0 bottom-0 bg-surface rounded-t-2xl shadow-2xl max-h-[80vh] overflow-hidden transform translate-y-full transition-transform duration-300 ease-out z-50">
    <div class="p-4 text-center border-b border-border relative">
      <div class="w-10 h-1 bg-border rounded-full mx-auto mb-3"></div>
      <div class="font-semibold text-lg">Start New Chat</div>
      <button id="close-sheet" class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl text-text-muted">×</button>
    </div>
    <div id="empty-chats-list" class="max-h-[calc(80vh-80px)] overflow-y-auto px-4"></div>
  </div>

  <!-- Sound -->
  <audio id="new-message-sound" preload="auto">
    <source src="https://bazukastore.com/sound/new-notification-010-352755.mp3" type="audio/mpeg" />
  </audio>

  <!-- FULL SCRIPT (only renderCard updated) -->
  <script>
    let socket;
    const API_BASE_URL = 'https://bazukastore.com/api';
    const FALLBACK_AVATAR = 'https://placehold.co/56x56?text=A';
    const NOTIFICATION_SOUND = document.getElementById('new-message-sound');

    const colors = ['#667eea','#764ba2','#f093fb','#f5576c','#4facfe','#00f2fe','#43e97b','#38f9d7','#ffeaa7','#fab1a0'];
    const getColor = () => colors[Math.floor(Math.random() * colors.length)];
    const getInitial = n => n ? n[0].toUpperCase() : 'A';

    const showToast = (msg, type = 'success') => {
      const t = document.createElement('div');
      t.className = `fixed bottom-20 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full text-sm font-medium shadow-lg transition ${type === 'error' ? 'bg-error text-white' : 'bg-surface text-text'} z-50`;
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.classList.add('opacity-100'), 50);
      setTimeout(() => { t.classList.remove('opacity-100'); setTimeout(() => t.remove(), 300); }, 2200);
    };

    const formatCount = c => c === 0 ? '' : c > 99 ? '99+' : c > 3 ? '4+' : c.toString();

    // AUTH
    const refreshToken = async () => {
      try {
        const r = await fetch(`${API_BASE_URL}/auth/refresh`, { method: 'POST', credentials: 'include' });
        if (!r.ok) return false;
        const { token } = await r.json();
        localStorage.setItem('token', token);
        if (socket) { socket.auth = { token: `Bearer ${token}` }; socket.connect(); }
        return true;
      } catch { return false; }
    };

    const checkAuth = async (retry = 0, max = 2) => {
      const t = localStorage.getItem('token');
      if (!t) return false;
      try {
        const r = await fetch(`${API_BASE_URL}/users/profile`, { headers: { Authorization: `Bearer ${t}` } });
        if (r.status === 401 && retry < max && await refreshToken()) return checkAuth(retry + 1, max);
        return r.ok;
      } catch {
        if (retry < max) { await new Promise(s => setTimeout(s, 1000)); return checkAuth(retry + 1, max); }
        localStorage.removeItem('token');
        return false;
      }
    };

    // RENDER CARD - FIXED: WHITE BORDER ON ALL AVATARS
    const renderCard = c => {
      const name = c.recipient?.name || 'Unknown';
      const hasAvatar = c.recipient?.avatar;
      const initial = getInitial(name);
      const color = !hasAvatar ? getColor() : '';
      const preview = c.lastMessage || 'No messages yet';
      const time = c.updatedAt ? new Date(c.updatedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
      const unread = c.unreadCount || 0;
      const showBadge = unread > 0;
      const badgeText = formatCount(unread);
      const isDot = unread === 1;
      const badge = showBadge ? `<div class="absolute -top-1 -right-1 min-w-5 h-5 bg-error text-white text-xs font-bold rounded-full flex items-center justify-center border-2 !border-white shadow ${isDot ? 'w-3 h-3' : ''}">${isDot ? '' : badgeText}</div>` : '';

      return `
        <div class="flex items-center py-3 border-b border-border hover:bg-hover cursor-pointer transition" data-chat-id="${c._id}" onclick="location.href='/chat.html?chatId=${c._id}'">
          <div class="relative mr-3 flex-shrink-0">
            ${hasAvatar
              ? `<img src="${c.recipient.avatar}" alt="${name}" class="w-14 h-14 rounded-full object-cover !border-4 !border-white shadow-sm" onerror="this.src='${FALLBACK_AVATAR}'">`
              : `<div class="w-14 h-14 rounded-full !border-4 !border-white shadow-sm flex items-center justify-center text-xl font-bold text-gray-600" style="background:${color}">${initial}</div>`
            }
            ${badge}
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-base truncate">${name}</div>
            <div class="text-sm text-text-muted truncate">${preview}</div>
          </div>
          ${time ? `<div class="text-xs text-text-muted pl-2">${time}</div>` : ''}
        </div>
      `;
    };

    const playSound = () => { NOTIFICATION_SOUND.currentTime = 0; NOTIFICATION_SOUND.play().catch(() => {}); };

    const renderAll = chats => {
      const active = chats.filter(c => c.lastMessage);
      const noMsg = chats.filter(c => !c.lastMessage);

      const $active = document.getElementById('active-chats');
      const $empty = document.getElementById('empty-chats-list');

      $active.innerHTML = active.length 
        ? active.map(renderCard).join('') 
        : '<p class="text-center py-12 text-text-muted text-sm">No active chats yet.</p>';

      $empty.innerHTML = noMsg.length
        ? noMsg.map(renderCard).join('')
        : '<p class="text-center py-12 text-text-muted text-sm italic">Chats with no messages appear here — tap to start.</p>';
    };

    const silentFetchChats = async (isNew = false) => {
      if (!(await checkAuth())) return;
      const t = localStorage.getItem('token');
      try {
        const r = await fetch(`${API_BASE_URL}/chats`, { headers: { Authorization: `Bearer ${t}` } });
        const data = await r.json();
        if (!r.ok) throw new Error();
        const scrollY = window.scrollY;
        renderAll(data);
        if (isNew) {
          playSound();
          anime({ targets: '#active-chats > div', opacity: [0.8, 1], translateY: [-4, 0], duration: 300, easing: 'easeOutQuad' });
        }
        window.scrollTo(0, scrollY);
      } catch (e) { console.error(e); }
    };

    const fetchChats = async (retry = 0, max = 2) => {
      if (!(await checkAuth())) {
        showToast('Sign in required.', 'error');
        setTimeout(() => location.href = `/login.html?redirect=${encodeURIComponent(location.pathname)}`, 2000);
        return;
      }

      const $active = document.getElementById('active-chats');
      $active.innerHTML = Array(3).fill().map(() => `<div class="h-20 rounded-lg shimmer"></div>`).join('');

      const t = localStorage.getItem('token');
      try {
        const r = await fetch(`${API_BASE_URL}/chats`, { headers: { Authorization: `Bearer ${t}` } });
        const data = await r.json();
        if (!r.ok) {
          if (r.status === 401 && retry < max && await refreshToken()) return fetchChats(retry + 1, max);
          throw new Error(data.message || 'Failed');
        }
        renderAll(data);
        anime({
          targets: '#active-chats > div',
          opacity: [0, 1],
          translateY: [30, 0],
          duration: 600,
          delay: anime.stagger(80),
          easing: 'easeOutExpo'
        });
      } catch (e) {
        showToast(`Load failed: ${e.message}`, 'error');
        $active.innerHTML = '<p class="text-center py-12 text-text-muted">Failed to load. <a href="#" onclick="location.reload()" class="text-primary font-semibold">Retry</a></p>';
      } finally {
        const loader = document.getElementById('loader');
        loader.classList.add('opacity-0');
        setTimeout(() => loader.remove(), 500);
      }
    };

    // FAB & Sheet
    const fab = document.getElementById('fab');
    const sheet = document.getElementById('bottom-sheet');
    const close = document.getElementById('close-sheet');

    fab.onclick = () => sheet.classList.remove('translate-y-full');
    close.onclick = () => sheet.classList.add('translate-y-full');
    sheet.onclick = e => { if (e.target === sheet) sheet.classList.add('translate-y-full'); };

    const setupBack = () => document.getElementById('back-button').onclick = () => location.href = '/request.html';

    // INIT
    document.addEventListener('DOMContentLoaded', async () => {
      feather.replace();

      if (typeof io !== 'undefined') {
        socket = io('https://bazukastore.com', {
          withCredentials: true,
          auth: { token: `Bearer ${localStorage.getItem('token') || ''}` }
        });

        socket.on('connect', () => {
          const t = localStorage.getItem('token');
          if (t) socket.emit('joinUser', { token: `Bearer ${t}` }, res => {
            if (res?.error) { showToast('Session expired.', 'error'); localStorage.removeItem('token'); setTimeout(() => location.href = '/login.html', 2000); }
          });
        });

        socket.on('connect_error', () => setTimeout(async () => { if (await checkAuth()) socket.connect(); }, 5000));
        socket.on('chatUpdate', async () => { if (await checkAuth()) silentFetchChats(true); });
      }

      setTimeout(async () => {
        await fetchChats();
        setupBack();
      }, 100);
    });
  </script>
</body>
</html>